# Whole Skeleton Mean Diffusivity



```r
#load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(growthmodels)
library(broom)
```


```r
#bring in subject info (generated by 03_STOPPD_masterDF.Rmd)
# then take only the subjects who completed (n= 72 - note two were excluded for IF)
df <- read_csv('../generated_csvs/STOPPD_masterDF_2018-11-05.csv') %>%
  mutate(STUDYID = as.character(STUDYID)) %>%
  filter(second_complete == "Yes", MR_exclusion == "No") 

#rename timepoint variable for clarity
colnames(df)[colnames(df)=="second_timepoint"] <- "category" 

#make a datediff column for time between scans
df$dateDiff <- as.numeric(round(difftime(df$second_date, df$first_date, units = "days"), 0))

RandomArmColors = c( "#FFC200", "#007aa3")
```
## Known exclusion reasons

#### known DWI issues

**subject 410012 timepoint 02** -> scan was blacklisted "aborted" for system failure..no DWI for this participant

**subject 220009_timepoint 01** -> scan was also incomplete (this participant was only able complete the T1w)

So we will filter the data table to exclude these 2 participants (final n=71)


```r
df <- filter(df, !(STUDYID %in% c("410012", "220009")))
```

## mangling the Mean Diffusivity cata data

Erin reran the enigma DTI pipeline for only PMC using a different skull stripping parameter (-fa 0.7 to BET). We will use these numbers instead of the others in the archive here..


```r
#bring in MD data (from the filesystem)
MD_most <- read_csv('../data/enigma-DTI_archive_201811/enigmaDTI-MD-results.csv')
MD_PMC <- read_csv('../data/enigma-DTI_PMCredo_201809/enigmaDTI-MD-results.csv')

# separate id into it's parts and then drop old PMC data
MD_most <- MD_most %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  filter(site != "PMC")

# separate the PMC subject id into it's parts and then bind to the data from the other sites 
MD <- MD_PMC %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  bind_rows(MD_most)

# drop acute ("00") and other ("03") timepoints from the analysis
MD <- MD %>%  
  filter(!(timepoint %in% c("00", "03"))) %>%
  gather(tract, MD, ends_with("MD")) %>%
  spread(timepoint, MD) %>%
  mutate(change = `02` - `01`) %>%
  gather(timepoint, MD, `01`, `02`, change) %>%
  unite(tract_timepoint, tract, timepoint) %>%
  spread(tract_timepoint, MD)
```


## check for missing MD data


```r
# filter the master spreadsheet for the list of completers (no output means we are ok)
df %>%
  anti_join(MD, by = "STUDYID") %>%
  summarise(`Number of missing MD values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing MD values\\
\hline
0\\
\hline
\end{tabular}

## merge (i.e. join) the MD data with the clinical scores 


```r
all_MD <- df %>%
  select(STUDYID, sex, age, randomization, category, dateDiff) %>%
  mutate(RandomArm = factor(randomization, 
                       levels = c("O", "P"),
                       labels = c("Olanzapine", "Placebo"))) %>%
  left_join(MD, by = "STUDYID")

all_MD %>%
  filter(is.na(AverageFA_MD_01)) %>%
  summarise(`Number of missing timepoint 1 MD values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing timepoint 1 MD values\\
\hline
0\\
\hline
\end{tabular}

```r
all_MD %>%
  filter(is.na(AverageFA_MD_02)) %>%
  summarise(`Number of missing timepoint 2 MD values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing timepoint 2 MD values\\
\hline
0\\
\hline
\end{tabular}


```r
#write out clean MD speadsheet (required for subsequent MD analyses)
write.csv(all_MD, '../generated_csvs/STOPPD_MDclean.csv', row.names = FALSE)
```





## Running Table One to get baseline values


```r
library(tableone)
print(CreateTableOne(data = all_MD,
               strata = c("RandomArm"),
               vars = c("category", "AverageFA_MD_01")), contDigits = 5)
```

```
##                              Stratified by RandomArm
##                               Olanzapine        Placebo           p     
##   n                                37                34                 
##   category (%)                                                     0.004
##      Off protocol                   4 (10.8)          1 ( 2.9)          
##      RCT                           26 (70.3)         14 (41.2)          
##      Relapse                        7 (18.9)         19 (55.9)          
##   AverageFA_MD_01 (mean (sd)) 0.00142 (0.00017) 0.00136 (0.00019)  0.165
##                              Stratified by RandomArm
##                               test
##   n                               
##   category (%)                    
##      Off protocol                 
##      RCT                          
##      Relapse                      
##   AverageFA_MD_01 (mean (sd))
```


```r
print(CreateTableOne(data = all_MD,
               vars = c("category", "AverageFA_MD_01")), contDigits = 5)
```

```
##                              
##                               Overall          
##   n                                71          
##   category (%)                                 
##      Off protocol                   5 ( 7.0)   
##      RCT                           40 (56.3)   
##      Relapse                       26 (36.6)   
##   AverageFA_MD_01 (mean (sd)) 0.00140 (0.00018)
```

#### baseline t.test


```r
all_MD %>%
  select(RandomArm, AverageFA_MD_01) %>%
  gather(brain, mm, -RandomArm) %>%
  group_by(brain) %>%
  do(tidy(t.test(mm~RandomArm, data = .))) %>%
  select(brain, statistic, parameter, p.value, method) %>%
  rename(t = statistic, df = parameter) %>%
  knitr::kable(caption = "t.test for baseline group differences", digits = 2)
```

\begin{table}[t]

\caption{(\#tab:unnamed-chunk-9)t.test for baseline group differences}
\centering
\begin{tabular}{l|r|r|r|l}
\hline
brain & t & df & p.value & method\\
\hline
AverageFA\_MD\_01 & 1.4 & 67.41 & 0.17 & Welch Two Sample t-test\\
\hline
\end{tabular}
\end{table}

Note that there are very strong scanner effects so it is probably better to consider these by site..


```r
print(CreateTableOne(data = all_MD,
               strata = c("RandomArm","site"),
               vars = c("category", "AverageFA_MD_01")), contDigits = 5)
```

```
##                              Stratified by RandomArm:site
##                               Olanzapine:CMH    Placebo:CMH      
##   n                                18                11          
##   category (%)                                                   
##      Off protocol                   3 (16.7)          1 ( 9.1)   
##      RCT                           12 (66.7)          5 (45.5)   
##      Relapse                        3 (16.7)          5 (45.5)   
##   AverageFA_MD_01 (mean (sd)) 0.00151 (0.00018) 0.00151 (0.00013)
##                              Stratified by RandomArm:site
##                               Olanzapine:MAS    Placebo:MAS      
##   n                                 7                10          
##   category (%)                                                   
##      Off protocol                   0 ( 0.0)          0 ( 0.0)   
##      RCT                            4 (57.1)          4 (40.0)   
##      Relapse                        3 (42.9)          6 (60.0)   
##   AverageFA_MD_01 (mean (sd)) 0.00131 (0.00012) 0.00126 (0.00017)
##                              Stratified by RandomArm:site
##                               Olanzapine:NKI    Placebo:NKI      
##   n                                 6                 7          
##   category (%)                                                   
##      Off protocol                   0 (  0.0)         0 ( 0.0)   
##      RCT                            6 (100.0)         3 (42.9)   
##      Relapse                        0 (  0.0)         4 (57.1)   
##   AverageFA_MD_01 (mean (sd)) 0.00128 (0.00011) 0.00137 (0.00017)
##                              Stratified by RandomArm:site
##                               Olanzapine:PMC    Placebo:PMC       p     
##   n                                 6                 6                 
##   category (%)                                                     0.180
##      Off protocol                   1 (16.7)          0 ( 0.0)          
##      RCT                            4 (66.7)          2 (33.3)          
##      Relapse                        1 (16.7)          4 (66.7)          
##   AverageFA_MD_01 (mean (sd)) 0.00143 (0.00012) 0.00125 (0.00015) <0.001
##                              Stratified by RandomArm:site
##                               test
##   n                               
##   category (%)                    
##      Off protocol                 
##      RCT                          
##      Relapse                      
##   AverageFA_MD_01 (mean (sd))
```


## RCT only


```r
#boxplot of difference in MD in whole skeleton (y axis) by randomization group (x axis)
ggplot(RCT_MD, aes(x= RandomArm, y = diffAverageSkel_MD, fill = RandomArm)) + 
   geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
   geom_dotplot(binaxis = 'y', stackdir = 'center') +
   geom_hline(yintercept = 0) +
   xlab(NULL) +  
   ylab("Change in Mean Diffusivity") +
   scale_fill_manual(values = RandomArmColors) +
   scale_shape_manual(values = c(21)) +
   theme_bw()
```

```
## `stat_bindot()` using `bins = 30`. Pick better value with `binwidth`.
```

![](09_STOPPD_MD-meanFAskel_files/figure-latex/RCT_MD_meanSkel_plot_fig3B-1.pdf)<!-- --> 



```r
#run linear model with covariates of sex, age and site
fit_rct <- lmer(diffAverageSkel_MD ~ RandomArm + sex + age + (1|site), data= RCT_MD)
summary(fit_rct)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: diffAverageSkel_MD ~ RandomArm + sex + age + (1 | site)
##    Data: RCT_MD
## 
## REML criterion at convergence: -621.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.3065 -0.4491  0.0422  0.7902  1.4955 
## 
## Random effects:
##  Groups   Name        Variance                      Std.Dev.         
##  site     (Intercept) 0.000000000000000000000001198 0.000000000001094
##  Residual             0.000000001167888941144929037 0.000034174390136
## Number of obs: 40, groups:  site, 4
## 
## Fixed effects:
##                        Estimate     Std. Error             df t value
## (Intercept)       0.00001593673  0.00002145081 35.99999999947   0.743
## RandomArmPlacebo -0.00002622481  0.00001152451 35.99999999950  -2.276
## sexM              0.00000257258  0.00001109389 35.99999999972   0.232
## age               0.00000008944  0.00000039787 35.99999999925   0.225
##                  Pr(>|t|)  
## (Intercept)        0.4623  
## RandomArmPlacebo   0.0289 *
## sexM               0.8179  
## age                0.8234  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP sexM  
## RndmArmPlcb -0.022              
## sexM        -0.044  0.067       
## age         -0.921 -0.181 -0.201
```


## RCT & Relapse (with time as factor)



```r
RCTRelapse_wholeskelMD <- RCTRelapse_MD %>%
  filter(Tract == "AverageFA") %>%
  mutate(category = factor(category, levels = c("RCT","Relapse", "Off protocol")))
#plot
RCTRelapse_wholeskelMD %>%
  ggplot(aes(x=model_days, y=MD, fill = RandomArm)) + 
  geom_point(aes(shape = category)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", formula=y~poly(x,1)) +
  xlab("Days between MRIs") +  
  ylab("Mean Diffusivity") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw()
```

![](09_STOPPD_MD-meanFAskel_files/figure-latex/RCTRelapse_MD_plot_fig3D-1.pdf)<!-- --> 



```r
#run mixed linear model, with covariates
fit_all <- lmer(MD ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data= RCTRelapse_wholeskelMD)
summary(fit_all)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: 
## MD ~ RandomArm * model_days + sex + age + (1 | site) + (1 | STUDYID)
##    Data: RCTRelapse_wholeskelMD
## 
## REML criterion at convergence: -2246.8
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.75931 -0.44531 -0.00936  0.39581  1.91032 
## 
## Random effects:
##  Groups   Name        Variance        Std.Dev.  
##  STUDYID  (Intercept) 0.0000000077174 0.00008785
##  site     (Intercept) 0.0000000087245 0.00009340
##  Residual             0.0000000004336 0.00002082
## Number of obs: 142, groups:  STUDYID, 71; site, 4
## 
## Fixed effects:
##                                   Estimate     Std. Error             df
## (Intercept)                  0.00093603329  0.00006263043  8.68938506644
## RandomArmPlacebo            -0.00003682637  0.00002181291 66.85102591970
## model_days                   0.00000008623  0.00000002197 69.34886239368
## sexM                         0.00005832529  0.00002158631 64.19751680155
## age                          0.00000762514  0.00000069783 64.16140897910
## RandomArmPlacebo:model_days -0.00000009581  0.00000003699 69.94946322992
##                             t value             Pr(>|t|)    
## (Intercept)                  14.945 0.000000169265448769 ***
## RandomArmPlacebo             -1.688             0.096017 .  
## model_days                    3.925             0.000202 ***
## sexM                          2.702             0.008808 ** 
## age                          10.927 0.000000000000000276 ***
## RandomArmPlacebo:model_days  -2.590             0.011664 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP mdl_dy sexM   age   
## RndmArmPlcb -0.140                            
## model_days  -0.041  0.106                     
## sexM        -0.129  0.071  0.003              
## age         -0.590 -0.076  0.006 -0.086       
## RndmArmPl:_  0.023 -0.139 -0.594  0.001 -0.002
```


```r
RCTRelapse_wholeskelMD_sense <- RCTRelapse_wholeskelMD %>% filter(category != "Off protocol")
#run mixed linear model, with covariates
fit_all <- lmer(MD ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data= RCTRelapse_wholeskelMD_sense)
summary(fit_all)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: 
## MD ~ RandomArm * model_days + sex + age + (1 | site) + (1 | STUDYID)
##    Data: RCTRelapse_wholeskelMD_sense
## 
## REML criterion at convergence: -2074.6
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.75438 -0.43253 -0.00483  0.39766  1.90966 
## 
## Random effects:
##  Groups   Name        Variance       Std.Dev.  
##  STUDYID  (Intercept) 0.000000007944 0.00008913
##  site     (Intercept) 0.000000008402 0.00009166
##  Residual             0.000000000447 0.00002114
## Number of obs: 132, groups:  STUDYID, 66; site, 4
## 
## Fixed effects:
##                                   Estimate     Std. Error             df
## (Intercept)                  0.00093650663  0.00006296200  9.36164315607
## RandomArmPlacebo            -0.00003402152  0.00002283248 61.70059785288
## model_days                   0.00000009109  0.00000002314 64.26215950200
## sexM                         0.00006069042  0.00002282329 59.19528186801
## age                          0.00000756727  0.00000073617 59.14985441694
## RandomArmPlacebo:model_days -0.00000010128  0.00000003807 64.80607378513
##                             t value            Pr(>|t|)    
## (Intercept)                  14.874 0.00000007918918823 ***
## RandomArmPlacebo             -1.490            0.141306    
## model_days                    3.936            0.000206 ***
## sexM                          2.659            0.010062 *  
## age                          10.279 0.00000000000000881 ***
## RandomArmPlacebo:model_days  -2.661            0.009824 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP mdl_dy sexM   age   
## RndmArmPlcb -0.147                            
## model_days  -0.045  0.108                     
## sexM        -0.092  0.029  0.000              
## age         -0.608 -0.072  0.008 -0.134       
## RndmArmPl:_  0.027 -0.142 -0.608  0.005 -0.006
```

## adding the non-RCT people to the boxplot


```r
all_MD %>%
  mutate(Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  ggplot(aes(x= RandomArm, y = diffAverageSkel_MD, fill = Outcome)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center', 
                  position=position_dodge(0.8)) +
     geom_hline(yintercept = 0) +
     xlab(NULL) +
     ylab("change in MD between scans") +
     theme_bw() +
     scale_fill_manual(values = c('white','grey')) 
```

```
## `stat_bindot()` using `bins = 30`. Pick better value with `binwidth`.
```

![](09_STOPPD_MD-meanFAskel_files/figure-latex/unnamed-chunk-11-1.pdf)<!-- --> 

### post-hoc look at subgroups against 0 change null


```r
all_MD %>%
  mutate(Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  filter(category != "Off protocol") %>%
  group_by(RandomArm, category) %>%
  do(tidy(t.test(.$diffAverageSkel_MD, mu = 0, alternative = "two.sided"))) %>%
  knitr::kable(digits = 3)
```


\begin{tabular}{l|l|r|r|r|r|r|r|l|l}
\hline
RandomArm & category & estimate & statistic & p.value & parameter & conf.low & conf.high & method & alternative\\
\hline
Olanzapine & RCT & 0 & 3.235 & 0.003 & 25 & 0 & 0 & One Sample t-test & two.sided\\
\hline
Olanzapine & Relapse & 0 & 0.344 & 0.743 & 6 & 0 & 0 & One Sample t-test & two.sided\\
\hline
Placebo & RCT & 0 & -0.487 & 0.635 & 13 & 0 & 0 & One Sample t-test & two.sided\\
\hline
Placebo & Relapse & 0 & 2.021 & 0.058 & 18 & 0 & 0 & One Sample t-test & two.sided\\
\hline
\end{tabular}

## running exploratory Tractwise analysis

No significant effects found


```r
RCT_Tractwise <- RCT_MD %>%
  gather(elabel, change_MD, ends_with('_MD_change')) %>%
  filter(!str_detect(elabel, '-L'), 
         !str_detect(elabel, '-R'),
         !str_detect(elabel, 'Average')) %>%
  group_by(elabel) %>%
  do(tidy(lm(change_MD ~ RandomArm + sex + age + site, data= .))) %>%
  ungroup() %>% group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = 'fdr'))

RCT_Tractwise_suppltable <- RCT_Tractwise %>%
  filter(p_FDR < 0.06) %>%
  arrange(p.value) %>%
  ungroup() %>% select(-term, -p.value) 
RCT_Tractwise_suppltable %>% write_csv('../generated_csvs/suppltable4b_MDtractwise.csv')
RCT_Tractwise_suppltable %>%
  knitr::kable()
```


\begin{tabular}{l|r|r|r|r}
\hline
elabel & estimate & std.error & statistic & p\_FDR\\
\hline
SS\_MD\_change & -0.0000541 & 0.0000167 & -3.247844 & 0.0418925\\
\hline
FXST\_MD\_change & -0.0000564 & 0.0000186 & -3.034776 & 0.0418925\\
\hline
EC\_MD\_change & -0.0000526 & 0.0000176 & -2.990254 & 0.0418925\\
\hline
SLF\_MD\_change & -0.0000284 & 0.0000102 & -2.788888 & 0.0474893\\
\hline
RLIC\_MD\_change & -0.0000537 & 0.0000196 & -2.737613 & 0.0474893\\
\hline
\end{tabular}



```md
#cleanup
rm('df', 'fit_all', 'fit_rct', 'MD', 'plot', 'RCT_FA', 'RCTRelapse_FA')
```

