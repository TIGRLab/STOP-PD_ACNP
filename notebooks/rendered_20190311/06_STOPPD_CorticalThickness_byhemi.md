---
output:
  pdf_document: default
  html_document: default
---
# Cortical Thickness Analysis

This section runs the stats for average (by hemisphere) Cortical Thickness calculated with Freesurfer


```r
#load libraries
library(tidyverse)
library(broom)
library(lmerTest)
library(tableone)


#bring in data 
df <- read_csv('../generated_csvs/STOPPD_participantsCT_20181111.csv') #generated by 05_STOPPD_error in prepartion of Jason Lerch meeting
```



```r
#make sure that STUDYID is an interger not a number
  df$STUDYID <- as.character(df$STUDYID)

#make sure that dateDiff is a number, not an interger
  df$dateDiff <- as.numeric(df$dateDiff)

# label the randomization variable  
df$RandomArm <- factor(df$randomization, 
                       levels = c("O", "P"),
                       labels = c("Olanzapine", "Placebo"))

RandomArmColors = c( "#FFC200", "#007aa3")

# set category levels so that RCT and Relapse are at the top
df <- df %>%
  mutate(category = factor(category, levels = c("RCT","Relapse", "Off protocol")))

#restructure data for RCT completers' only (N=40)
  RCT_CT <- df %>%
    filter(category == "RCT") 



#write out clean dataframe
 # write.csv(RCT_CT, '../generated_data/df_leftCT.csv', row.names=FALSE)
```



#### baseline measures (table1 part 1)


```r
CreateTableOne(data = df,
               strata = "randomization",
               vars = c("category", "LThickness_01", "RThickness_01", "LSurfArea_01", "RSurfArea_01"))
```

```
##                            Stratified by randomization
##                             O                  P                   p     
##   n                               38                 34                  
##   category (%)                                                      0.008
##      RCT                          26 (68.4)          14 (41.2)           
##      Relapse                       8 (21.1)          19 (55.9)           
##      Off protocol                  4 (10.5)           1 ( 2.9)           
##   LThickness_01 (mean (sd))     2.41 (0.09)        2.41 (0.11)      0.927
##   RThickness_01 (mean (sd))     2.42 (0.08)        2.40 (0.11)      0.450
##   LSurfArea_01 (mean (sd))  83584.98 (9259.48) 81101.75 (10210.53)  0.283
##   RSurfArea_01 (mean (sd))  83263.46 (9340.81) 81436.34 (10146.92)  0.429
##                            Stratified by randomization
##                             test
##   n                             
##   category (%)                  
##      RCT                        
##      Relapse                    
##      Off protocol               
##   LThickness_01 (mean (sd))     
##   RThickness_01 (mean (sd))     
##   LSurfArea_01 (mean (sd))      
##   RSurfArea_01 (mean (sd))
```


```r
CreateTableOne(data = df,
               vars = c("category", "LThickness_01", "RThickness_01", "LSurfArea_01", "RSurfArea_01"))
```

```
##                            
##                             Overall           
##   n                               72          
##   category (%)                                
##      RCT                          40 (55.6)   
##      Relapse                      27 (37.5)   
##      Off protocol                  5 ( 6.9)   
##   LThickness_01 (mean (sd))     2.41 (0.10)   
##   RThickness_01 (mean (sd))     2.41 (0.10)   
##   LSurfArea_01 (mean (sd))  82412.34 (9731.16)
##   RSurfArea_01 (mean (sd))  82400.65 (9703.97)
```

#### baseline stats (part 2)


```r
df %>%
  select(randomization, LThickness_01, RThickness_01, LSurfArea_01, RSurfArea_01) %>%
  gather(thick, mm, -randomization) %>%
  group_by(thick) %>%
  do(tidy(t.test(mm~randomization, data = .))) %>%
  knitr::kable(caption = "t.test for baseline group differences")
```

\begin{table}[t]

\caption{(\#tab:unnamed-chunk-4)t.test for baseline group differences}
\centering
\begin{tabular}{l|r|r|r|r|r|r|r|r|l|l}
\hline
thick & estimate & estimate1 & estimate2 & statistic & p.value & parameter & conf.low & conf.high & method & alternative\\
\hline
LSurfArea\_01 & 2483.2345201 & 83584.981579 & 81101.747059 & 1.0763573 & 0.2856251 & 67.05205 & -2121.6362282 & 7088.1052684 & Welch Two Sample t-test & two.sided\\
\hline
LThickness\_01 & 0.0021686 & 2.412625 & 2.410456 & 0.0908530 & 0.9278969 & 63.17323 & -0.0455277 & 0.0498649 & Welch Two Sample t-test & two.sided\\
\hline
RSurfArea\_01 & 1827.1199690 & 83263.455263 & 81436.335294 & 0.7918366 & 0.4312325 & 67.43641 & -2778.0130382 & 6432.2529763 & Welch Two Sample t-test & two.sided\\
\hline
RThickness\_01 & 0.0171918 & 2.416510 & 2.399318 & 0.7478608 & 0.4573935 & 61.51826 & -0.0287677 & 0.0631513 & Welch Two Sample t-test & two.sided\\
\hline
\end{tabular}
\end{table}

## RCT only


```r
RCT_CT %>% count(randomization) %>% knitr::kable() 
```


\begin{tabular}{l|r}
\hline
randomization & n\\
\hline
O & 26\\
\hline
P & 14\\
\hline
\end{tabular}



```r
fit_all <- lmer(LThickness_change ~ RandomArm + sex + age + (1|site), data= RCT_CT)
summary(fit_all)  
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: LThickness_change ~ RandomArm + sex + age + (1 | site)
##    Data: RCT_CT
## 
## REML criterion at convergence: -143.3
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.89976 -0.57933  0.06257  0.56839  1.99100 
## 
## Random effects:
##  Groups   Name        Variance  Std.Dev.
##  site     (Intercept) 0.0001067 0.01033 
##  Residual             0.0006323 0.02515 
## Number of obs: 40, groups:  site, 4
## 
## Fixed effects:
##                    Estimate Std. Error         df t value Pr(>|t|)    
## (Intercept)      -0.0116931  0.0176082 28.2935474  -0.664    0.512    
## RandomArmPlacebo  0.0401890  0.0085744 34.3857775   4.687 4.26e-05 ***
## sexM              0.0113835  0.0082471 34.2168472   1.380    0.176    
## age              -0.0003708  0.0003075 35.9997290  -1.206    0.236    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP sexM  
## RndmArmPlcb -0.007              
## sexM        -0.066  0.076       
## age         -0.881 -0.194 -0.178
```

```r
fit_all <- lmer(RThickness_change ~ RandomArm + sex + age + (1|site), data= RCT_CT)
summary(fit_all)  
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: RThickness_change ~ RandomArm + sex + age + (1 | site)
##    Data: RCT_CT
## 
## REML criterion at convergence: -139
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.4823 -0.6212 -0.0391  0.6947  1.7575 
## 
## Random effects:
##  Groups   Name        Variance  Std.Dev.
##  site     (Intercept) 1.569e-05 0.003961
##  Residual             7.557e-04 0.027490
## Number of obs: 40, groups:  site, 4
## 
## Fixed effects:
##                    Estimate Std. Error         df t value Pr(>|t|)    
## (Intercept)      -0.0112925  0.0176225 28.1556699  -0.641 0.526835    
## RandomArmPlacebo  0.0338477  0.0092972 35.0818648   3.641 0.000869 ***
## sexM             -0.0039112  0.0089510 35.0847652  -0.437 0.664819    
## age              -0.0002273  0.0003235 35.3460195  -0.703 0.486881    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP sexM  
## RndmArmPlcb -0.020              
## sexM        -0.050  0.070       
## age         -0.915 -0.184 -0.196
```

### looking at the same thing for Right CT



```r
#boxplot of difference in thickness (y axis) by randoMR_exclusion == "No"mization group (x axis)
RCT_CT %>%
  gather(TCT, mm, LThickness_change, RThickness_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LThickness_change", "RThickness_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere"))) %>%
ggplot(aes(x= RandomArm, y = mm, fill = RandomArm)) + 
     geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center', binwidth = 0.005) +
     geom_hline(yintercept = 0) +
     labs(x = NULL, y = "Change in Cortical Thickness (mm)") +
     scale_fill_manual(values = RandomArmColors) +
     scale_shape_manual(values = c(21)) +
     facet_wrap(~ ThickChange) +
     theme_bw()
```

![](06_STOPPD_CorticalThickness_byhemi_files/figure-latex/RCT_CT_facet_boxplot_fig2A-1.pdf)<!-- --> 


## RCT & Relapse (with time as factor)


```r
#restructure data for RCT & Relapse participants (N=72)
  RCTRelapse_LCT <- df %>%
    gather(thick_oldcolname, thickness, LThickness_01, LThickness_02) %>%
    mutate(model_days = if_else(thick_oldcolname == "LThickness_01", 1, dateDiff)) %>%
    mutate(category = factor(category, levels = c("RCT","Relapse", "Off protocol")),
           hemi = "Left Hemisphere")

RCTRelapse_LCT %>% filter(model_days == 1) %>% count(RandomArm, offLabel) %>% knitr::kable() 
```


\begin{tabular}{l|l|r}
\hline
RandomArm & offLabel & n\\
\hline
Olanzapine & Yes & 3\\
\hline
Olanzapine & NA & 35\\
\hline
Placebo & Yes & 4\\
\hline
Placebo & NA & 30\\
\hline
\end{tabular}

```r
RCTRelapse_LCT_sensitivety <- RCTRelapse_LCT %>% 
  filter(category != "Off protocol" )  

RCTRelapse_LCT_sensitivety %>% filter(model_days == 1) %>% count(RandomArm, offLabel) %>% knitr::kable() 
```


\begin{tabular}{l|l|r}
\hline
RandomArm & offLabel & n\\
\hline
Olanzapine & Yes & 1\\
\hline
Olanzapine & NA & 33\\
\hline
Placebo & Yes & 4\\
\hline
Placebo & NA & 29\\
\hline
\end{tabular}



```r
RCTRelapse_LCT %>%
  ggplot(aes(x=model_days, y=thickness, fill = RandomArm)) + 
  geom_point(aes(shape = category)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm") +
  labs(x = "Days between MRIs", y = "Cortical Thickness (mm)", colour = NULL) +
  scale_color_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  scale_y_continuous(limits = c(2.1,2.65)) +
  theme_bw()  +
  facet_wrap(~hemi)
```

![](06_STOPPD_CorticalThickness_byhemi_files/figure-latex/RCTRelapse_LCT_plot_fig2CL-1.pdf)<!-- --> 





```r
#run mixed linear model, with covariates
  fit_all <- lmer(thickness ~ RandomArm*model_days + age + sex + (1|site) + (1|STUDYID), data= RCTRelapse_LCT)
  summary(fit_all)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: thickness ~ RandomArm * model_days + age + sex + (1 | site) +  
##     (1 | STUDYID)
##    Data: RCTRelapse_LCT
## 
## REML criterion at convergence: -396
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.89073 -0.39603 -0.02082  0.40944  2.76834 
## 
## Random effects:
##  Groups   Name        Variance  Std.Dev.
##  STUDYID  (Intercept) 0.0054535 0.07385 
##  site     (Intercept) 0.0000000 0.00000 
##  Residual             0.0004953 0.02225 
## Number of obs: 144, groups:  STUDYID, 72; site, 4
## 
## Fixed effects:
##                               Estimate Std. Error         df t value
## (Intercept)                  2.639e+00  3.484e-02  6.864e+01  75.756
## RandomArmPlacebo            -2.035e-03  1.816e-02  7.233e+01  -0.112
## model_days                  -8.012e-05  2.340e-05  7.056e+01  -3.424
## age                         -4.053e-03  5.853e-04  6.785e+01  -6.924
## sexM                        -6.099e-03  1.792e-02  6.784e+01  -0.340
## RandomArmPlacebo:model_days  1.297e-04  3.942e-05  7.148e+01   3.291
##                             Pr(>|t|)    
## (Intercept)                  < 2e-16 ***
## RandomArmPlacebo             0.91106    
## model_days                   0.00103 ** 
## age                         1.96e-09 ***
## sexM                         0.73470    
## RandomArmPlacebo:model_days  0.00155 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP mdl_dy age    sexM  
## RndmArmPlcb -0.206                            
## model_days  -0.077  0.133                     
## age         -0.901 -0.053  0.008              
## sexM        -0.171  0.036  0.001 -0.079       
## RndmArmPl:_  0.043 -0.176 -0.594 -0.003  0.004
```




```r
#run mixed linear model, with covariates
  fit_all <- lmer(thickness ~ RandomArm*model_days + age + sex + (1|site) + (1|STUDYID), data= RCTRelapse_LCT_sensitivety)
  summary(fit_all)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: thickness ~ RandomArm * model_days + age + sex + (1 | site) +  
##     (1 | STUDYID)
##    Data: RCTRelapse_LCT_sensitivety
## 
## REML criterion at convergence: -362.7
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.83429 -0.38168 -0.01433  0.38915  2.71136 
## 
## Random effects:
##  Groups   Name        Variance  Std.Dev. 
##  STUDYID  (Intercept) 5.347e-03 7.313e-02
##  site     (Intercept) 1.702e-17 4.126e-09
##  Residual             5.157e-04 2.271e-02
## Number of obs: 134, groups:  STUDYID, 67; site, 4
## 
## Fixed effects:
##                               Estimate Std. Error         df t value
## (Intercept)                  2.651e+00  3.527e-02  6.373e+01  75.157
## RandomArmPlacebo             2.523e-03  1.865e-02  6.737e+01   0.135
## model_days                  -7.971e-05  2.477e-05  6.544e+01  -3.218
## age                         -4.352e-03  6.040e-04  6.285e+01  -7.205
## sexM                        -6.065e-04  1.854e-02  6.285e+01  -0.033
## RandomArmPlacebo:model_days  1.293e-04  4.076e-05  6.632e+01   3.172
##                             Pr(>|t|)    
## (Intercept)                  < 2e-16 ***
## RandomArmPlacebo             0.89280    
## model_days                   0.00201 ** 
## age                         8.88e-10 ***
## sexM                         0.97402    
## RandomArmPlacebo:model_days  0.00229 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP mdl_dy age    sexM  
## RndmArmPlcb -0.211                            
## model_days  -0.084  0.141                     
## age         -0.899 -0.052  0.011              
## sexM        -0.115 -0.008 -0.003 -0.126       
## RndmArmPl:_  0.051 -0.184 -0.608 -0.008  0.009
```

### Running the right hemisphere RCTRelapse


```r
#restructure data for RCT & Relapse participants (N=72)
  RCTRelapse_RCT <- df %>%
    gather(thick_oldcolname, thickness, RThickness_01, RThickness_02) %>%
    mutate(model_days = if_else(thick_oldcolname == "RThickness_01", 1, dateDiff)) %>%
    mutate(category = factor(category, levels = c("RCT","Relapse", "Off protocol")),
           hemi = "Right Hemisphere")

RCTRelapse_RCT_sensitivety <- RCTRelapse_RCT %>% 
  filter(category != "Off protocol" )  
```


```r
RCTRelapse_RCT %>%
  ggplot(aes(x=model_days, y=thickness, fill = RandomArm)) + 
  geom_point(aes(shape = category)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm") +
  labs(x = "Days between MRIs", y = "Cortical Thickness (mm)", colour = NULL) +
  scale_color_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  scale_y_continuous(limits = c(2.1,2.65)) +
  theme_bw()  +
  facet_wrap(~hemi)
```

![](06_STOPPD_CorticalThickness_byhemi_files/figure-latex/RCTRelapse_RCT_plot_fig2CR-1.pdf)<!-- --> 

```r
#run mixed linear model, with covariates
  fit_all <- lmer(thickness ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data= RCTRelapse_RCT)
  summary(fit_all)  
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: thickness ~ RandomArm * model_days + sex + age + (1 | site) +  
##     (1 | STUDYID)
##    Data: RCTRelapse_RCT
## 
## REML criterion at convergence: -409
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.34720 -0.42608 -0.01215  0.43733  2.27881 
## 
## Random effects:
##  Groups   Name        Variance  Std.Dev.
##  STUDYID  (Intercept) 0.0057442 0.07579 
##  site     (Intercept) 0.0000000 0.00000 
##  Residual             0.0003947 0.01987 
## Number of obs: 144, groups:  STUDYID, 72; site, 4
## 
## Fixed effects:
##                               Estimate Std. Error         df t value
## (Intercept)                  2.618e+00  3.554e-02  6.847e+01  73.658
## RandomArmPlacebo            -1.455e-02  1.847e-02  7.131e+01  -0.788
## model_days                  -8.813e-05  2.090e-05  7.041e+01  -4.216
## sexM                        -7.789e-03  1.830e-02  6.786e+01  -0.426
## age                         -3.588e-03  5.975e-04  6.786e+01  -6.004
## RandomArmPlacebo:model_days  1.281e-04  3.524e-05  7.112e+01   3.635
##                             Pr(>|t|)    
## (Intercept)                  < 2e-16 ***
## RandomArmPlacebo            0.433361    
## model_days                  7.28e-05 ***
## sexM                        0.671706    
## age                         8.40e-08 ***
## RandomArmPlacebo:model_days 0.000522 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP mdl_dy sexM   age   
## RndmArmPlcb -0.205                            
## model_days  -0.067  0.117                     
## sexM        -0.172  0.036  0.001              
## age         -0.902 -0.053  0.007 -0.079       
## RndmArmPl:_  0.037 -0.155 -0.593  0.003 -0.002
```



```r
#run mixed linear model, with covariates
  fit_all <- lmer(thickness ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data= RCTRelapse_RCT_sensitivety)
  summary(fit_all)  
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: thickness ~ RandomArm * model_days + sex + age + (1 | site) +  
##     (1 | STUDYID)
##    Data: RCTRelapse_RCT_sensitivety
## 
## REML criterion at convergence: -376.7
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.33892 -0.43051 -0.02586  0.45841  2.27007 
## 
## Random effects:
##  Groups   Name        Variance  Std.Dev.
##  STUDYID  (Intercept) 0.0056833 0.07539 
##  site     (Intercept) 0.0000000 0.00000 
##  Residual             0.0003973 0.01993 
## Number of obs: 134, groups:  STUDYID, 67; site, 4
## 
## Fixed effects:
##                               Estimate Std. Error         df t value
## (Intercept)                  2.628e+00  3.609e-02  6.353e+01  72.807
## RandomArmPlacebo            -1.094e-02  1.902e-02  6.621e+01  -0.575
## model_days                  -9.212e-05  2.176e-05  6.532e+01  -4.234
## sexM                        -2.307e-03  1.900e-02  6.288e+01  -0.121
## age                         -3.829e-03  6.187e-04  6.288e+01  -6.188
## RandomArmPlacebo:model_days  1.313e-04  3.583e-05  6.596e+01   3.664
##                             Pr(>|t|)    
## (Intercept)                  < 2e-16 ***
## RandomArmPlacebo            0.567192    
## model_days                  7.33e-05 ***
## sexM                        0.903719    
## age                         5.10e-08 ***
## RandomArmPlacebo:model_days 0.000496 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP mdl_dy sexM   age   
## RndmArmPlcb -0.209                            
## model_days  -0.072  0.121                     
## sexM        -0.115 -0.008 -0.002              
## age         -0.900 -0.052  0.009 -0.126       
## RndmArmPl:_  0.043 -0.158 -0.607  0.008 -0.007
```

### Playing with other ways to layout the plots



```r
RCTRelapse_LCT %>%
  ggplot(aes(x=model_days, y=thickness, colour = category)) +
  geom_point() +
  geom_line(aes(group=STUDYID), alpha = 0.5) +
  ggtitle("Cortical thickness in left hemisphere over time") +
  labs(x = "Days between MRIs", y = "Cortical Thickness (mm)", colour = NULL) +
  theme_minimal() + facet_wrap(~ RandomArm) +
  scale_colour_discrete(direction = -1)
```

![](06_STOPPD_CorticalThickness_byhemi_files/figure-latex/RCTRelapse_LCT_plot_2part1-1.pdf)<!-- --> 


```r
RCTRelapse_LCT %>%
  mutate(Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  ggplot(aes(x=model_days, y=thickness, fill = category)) +
  geom_point() +
  geom_line(aes(group=STUDYID), alpha = 0.5) +
  ggtitle("Cortical thickness in left hemisphere over time") +
  labs(x = "Days between MRIs", y = "Cortical Thickness (mm)", colour = NULL) +
  theme_bw() + facet_wrap(~ RandomArm) +
  scale_colour_manual(values = c("black", "white", "grey"))
```

![](06_STOPPD_CorticalThickness_byhemi_files/figure-latex/RCTRelapse_RCT_plot_2part2-1.pdf)<!-- --> 

## Post-Hoc - looking at subgroups

plotting change for all participants



```r
df %>%
  gather(TCT, mm, LThickness_change, RThickness_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LThickness_change", "RThickness_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere")),
         Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  ggplot(aes(x= RandomArm, y = mm, fill = Outcome)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center', 
                  position=position_dodge(0.8), binwidth = 0.005) +
     geom_hline(yintercept = 0) +
     xlab(NULL) +
     ylab("Change in Cortical Thickness (mm)") +
     theme_bw() +
     scale_fill_manual(values = c('white','grey')) +
     facet_wrap(~ThickChange)
```

![](06_STOPPD_CorticalThickness_byhemi_files/figure-latex/unnamed-chunk-5-1.pdf)<!-- --> 


```r
df %>%
  gather(TCT, mm, LThickness_change, RThickness_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LThickness_change", "RThickness_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere")),
         Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  filter(category != "Off protocol") %>%
  group_by(ThickChange, RandomArm, category) %>%
  do(tidy(t.test(.$mm, mu = 0, alternative = "two.sided"))) %>%
  knitr::kable(digits = 3)
```


\begin{tabular}{l|l|l|r|r|r|r|r|r|l|l}
\hline
ThickChange & RandomArm & category & estimate & statistic & p.value & parameter & conf.low & conf.high & method & alternative\\
\hline
Left Hemisphere & Olanzapine & RCT & -0.023 & -4.542 & 0.000 & 25 & -0.033 & -0.012 & One Sample t-test & two.sided\\
\hline
Left Hemisphere & Olanzapine & Relapse & 0.015 & 1.208 & 0.266 & 7 & -0.014 & 0.044 & One Sample t-test & two.sided\\
\hline
Left Hemisphere & Placebo & RCT & 0.014 & 1.754 & 0.103 & 13 & -0.003 & 0.031 & One Sample t-test & two.sided\\
\hline
Left Hemisphere & Placebo & Relapse & -0.013 & -1.678 & 0.111 & 18 & -0.030 & 0.003 & One Sample t-test & two.sided\\
\hline
Right Hemisphere & Olanzapine & RCT & -0.024 & -4.156 & 0.000 & 25 & -0.036 & -0.012 & One Sample t-test & two.sided\\
\hline
Right Hemisphere & Olanzapine & Relapse & 0.002 & 0.380 & 0.715 & 7 & -0.013 & 0.018 & One Sample t-test & two.sided\\
\hline
Right Hemisphere & Placebo & RCT & 0.008 & 1.428 & 0.177 & 13 & -0.004 & 0.021 & One Sample t-test & two.sided\\
\hline
Right Hemisphere & Placebo & Relapse & -0.003 & -0.363 & 0.721 & 18 & -0.019 & 0.013 & One Sample t-test & two.sided\\
\hline
\end{tabular}
## Exploratory within Treatment Arm tests


```r
df %>%
  gather(TCT, mm, LThickness_change, RThickness_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LThickness_change", "RThickness_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere")),
         Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  filter(category != "Off protocol") %>%
  group_by(ThickChange, RandomArm) %>%
  do(tidy(t.test(mm~category, var.equal = FALSE, data = .))) %>%
  knitr::kable(digits = 3)
```


\begin{tabular}{l|l|r|r|r|r|r|r|r|r|l|l}
\hline
ThickChange & RandomArm & estimate & estimate1 & estimate2 & statistic & p.value & parameter & conf.low & conf.high & method & alternative\\
\hline
Left Hemisphere & Olanzapine & -0.037 & -0.023 & 0.015 & -2.822 & 0.019 & 9.402 & -0.067 & -0.008 & Welch Two Sample t-test & two.sided\\
\hline
Left Hemisphere & Placebo & 0.027 & 0.014 & -0.013 & 2.427 & 0.021 & 30.107 & 0.004 & 0.050 & Welch Two Sample t-test & two.sided\\
\hline
Right Hemisphere & Olanzapine & -0.027 & -0.024 & 0.002 & -3.061 & 0.006 & 19.342 & -0.045 & -0.008 & Welch Two Sample t-test & two.sided\\
\hline
Right Hemisphere & Placebo & 0.011 & 0.008 & -0.003 & 1.158 & 0.256 & 30.715 & -0.008 & 0.030 & Welch Two Sample t-test & two.sided\\
\hline
\end{tabular}

```r
df %>%
  gather(TCT, mm, LThickness_change, RThickness_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LThickness_change", "RThickness_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere")),
         Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  filter(category != "Off protocol") %>%
  group_by(ThickChange, RandomArm) %>%
  do(tidy(lm(mm~category + age + sex + site, var.equal = FALSE, data = .))) %>%
  filter(term == "categoryRelapse") %>%
  knitr::kable(digits = 3)
```

```
## Warning: In lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) :
##  extra argument 'var.equal' will be disregarded

## Warning: In lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) :
##  extra argument 'var.equal' will be disregarded

## Warning: In lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) :
##  extra argument 'var.equal' will be disregarded

## Warning: In lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) :
##  extra argument 'var.equal' will be disregarded
```


\begin{tabular}{l|l|l|r|r|r|r}
\hline
ThickChange & RandomArm & term & estimate & std.error & statistic & p.value\\
\hline
Left Hemisphere & Olanzapine & categoryRelapse & 0.043 & 0.013 & 3.368 & 0.002\\
\hline
Left Hemisphere & Placebo & categoryRelapse & -0.025 & 0.011 & -2.327 & 0.028\\
\hline
Right Hemisphere & Olanzapine & categoryRelapse & 0.032 & 0.013 & 2.549 & 0.017\\
\hline
Right Hemisphere & Placebo & categoryRelapse & -0.009 & 0.010 & -0.915 & 0.369\\
\hline
\end{tabular}

```r
df %>%
  gather(TCT, mm, LThickness_change, RThickness_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LThickness_change", "RThickness_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere")),
         MRdays = as.numeric(dateDiff)) %>%
  filter(category != "Off protocol") %>%
  group_by(ThickChange, RandomArm) %>%
  do(tidy(lm(mm~MRdays, data = .))) %>%
  filter(term == "MRdays") %>%
  knitr::kable(digits = 3)
```


\begin{tabular}{l|l|l|r|r|r|r}
\hline
ThickChange & RandomArm & term & estimate & std.error & statistic & p.value\\
\hline
Left Hemisphere & Olanzapine & MRdays & 0 & 0 & -2.832 & 0.008\\
\hline
Left Hemisphere & Placebo & MRdays & 0 & 0 & 2.567 & 0.015\\
\hline
Right Hemisphere & Olanzapine & MRdays & 0 & 0 & -2.106 & 0.043\\
\hline
Right Hemisphere & Placebo & MRdays & 0 & 0 & 1.373 & 0.179\\
\hline
\end{tabular}

```r
df %>%
  gather(TCT, mm, LThickness_change, RThickness_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LThickness_change", "RThickness_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere")),
         MRdays = as.numeric(dateDiff)) %>%
  filter(category != "Off protocol") %>%
  ggplot(aes(x = MRdays, y = mm)) +
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_grid(RandomArm ~ ThickChange)
```

![](06_STOPPD_CorticalThickness_byhemi_files/figure-latex/unnamed-chunk-10-1.pdf)<!-- --> 

## Exporatory ROI Analysis..

Running the RCT analysis ROI-wise with FDR correction. 


```r
library(ggseg)
library(magrittr)
```

```
## 
## Attaching package: 'magrittr'
```

```
## The following object is masked from 'package:purrr':
## 
##     set_names
```

```
## The following object is masked from 'package:tidyr':
## 
##     extract
```

```r
library(dplyr)
library(broom)
```





```r
RCT_ROIwise <- RCT_CT %>%
  gather(elabel, change_mm, ends_with('_thickavg_change')) %>%
  group_by(elabel) %>%
  do(tidy(lm(change_mm ~ RandomArm + sex + age + site, data= .))) %>%
  ungroup() %>% group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = 'fdr'))

RCT_ROIwise_supptable = RCT_ROIwise %>%
  filter(p_FDR < 0.06) %>%
  arrange(p.value) %>%
  mutate(ROI = str_replace(elabel, '_thickavg_change', '')) %>%
  ungroup() %>%
  select(ROI, estimate, std.error, statistic, p_FDR)

RCT_ROIwise_supptable %>% write_csv('../generated_csvs/supptable4_thickbyROI.csv')

RCT_ROIwise_supptable %>%
  knitr::kable(digits = 3)
```


\begin{tabular}{l|r|r|r|r}
\hline
ROI & estimate & std.error & statistic & p\_FDR\\
\hline
L\_parsopercularis & 0.069 & 0.012 & 5.816 & 0.000\\
\hline
L\_middletemporal & 0.069 & 0.013 & 5.403 & 0.000\\
\hline
L\_superiortemporal & 0.059 & 0.013 & 4.554 & 0.001\\
\hline
L\_parstriangularis & 0.060 & 0.013 & 4.545 & 0.001\\
\hline
R\_fusiform & 0.070 & 0.017 & 4.178 & 0.003\\
\hline
L\_superiorfrontal & 0.054 & 0.013 & 4.037 & 0.003\\
\hline
L\_inferiortemporal & 0.070 & 0.019 & 3.780 & 0.005\\
\hline
L\_fusiform & 0.060 & 0.016 & 3.770 & 0.005\\
\hline
L\_caudalanteriorcingulate & 0.077 & 0.021 & 3.713 & 0.005\\
\hline
R\_inferiortemporal & 0.058 & 0.016 & 3.707 & 0.005\\
\hline
R\_lateraloccipital & 0.049 & 0.014 & 3.557 & 0.007\\
\hline
L\_rostralmiddlefrontal & 0.040 & 0.011 & 3.534 & 0.007\\
\hline
L\_bankssts & 0.056 & 0.016 & 3.483 & 0.007\\
\hline
R\_lateralorbitofrontal & 0.052 & 0.016 & 3.305 & 0.011\\
\hline
R\_middletemporal & 0.044 & 0.014 & 3.178 & 0.015\\
\hline
L\_transversetemporal & 0.096 & 0.031 & 3.076 & 0.017\\
\hline
L\_precentral & 0.065 & 0.021 & 3.072 & 0.017\\
\hline
R\_lingual & 0.052 & 0.017 & 3.025 & 0.018\\
\hline
L\_caudalmiddlefrontal & 0.044 & 0.015 & 3.005 & 0.018\\
\hline
R\_paracentral & 0.059 & 0.020 & 2.953 & 0.019\\
\hline
L\_lateralorbitofrontal & 0.057 & 0.019 & 2.947 & 0.019\\
\hline
R\_superiortemporal & 0.051 & 0.017 & 2.925 & 0.019\\
\hline
R\_superiorfrontal & 0.043 & 0.015 & 2.893 & 0.020\\
\hline
R\_postcentral & 0.030 & 0.011 & 2.771 & 0.026\\
\hline
R\_parahippocampal & 0.085 & 0.031 & 2.746 & 0.026\\
\hline
L\_parsorbitalis & 0.052 & 0.019 & 2.678 & 0.030\\
\hline
L\_lateraloccipital & 0.038 & 0.015 & 2.543 & 0.040\\
\hline
L\_insula & 0.058 & 0.024 & 2.433 & 0.049\\
\hline
R\_parsopercularis & 0.037 & 0.015 & 2.418 & 0.049\\
\hline
R\_caudalanteriorcingulate & 0.072 & 0.030 & 2.415 & 0.049\\
\hline
R\_insula & 0.051 & 0.022 & 2.335 & 0.057\\
\hline
\end{tabular}

```r
library(viridis)
```

```
## Loading required package: viridisLite
```

```r
RCT_ROIwise %>%
  ungroup() %>%
  filter(term == "RandomArmPlacebo") %>%
  mutate(label = str_replace(elabel, '_thickavg_change', '') %>%
           str_replace('L','lh') %>%
           str_replace('R','rh'),
         is_sig = if_else(p_FDR < 0.055, "sig", NA_character_)) %>%
  inner_join(atlas.info$data[2][[1]], by = "label") %>%
  ggseg(atlas="dkt", mapping=aes(fill=statistic, color = is_sig)) +
  scale_fill_viridis() +
  scale_color_manual(values = c("black", NULL)) + 
  labs(color = NULL, fill = "t-statistic")
```

![](06_STOPPD_CorticalThickness_byhemi_files/figure-latex/roiwise_cort_thickness_plot_supplfig-1.pdf)<!-- --> 

### Figure Caption (brain plots) 

Mapping the effect of olanzapine vs placebo on cortical thinning over 36 weeks in participant who remained clinically stable. The color scale represents the t-statistic for the effect of treatment (Placebo vs Olanzapine) where brighter colors represents greater cortical thinning. Areas outlined in black are those where the treatment effects was significant after correction for multiple comparisons (across 68 brain regions) using False Discovery Rate. 

