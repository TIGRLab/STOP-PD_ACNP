# Whole Skeleton Fractional Anisotropy 


```r
#load libraries
library(tidyverse)
```

```
## -- Attaching packages --------------------------------------------------------------------------------------------- tidyverse 1.2.1 --
```

```
## v ggplot2 3.1.0     v purrr   0.2.5
## v tibble  1.4.2     v dplyr   0.7.8
## v tidyr   0.8.2     v stringr 1.3.1
## v readr   1.1.1     v forcats 0.2.0
```

```
## -- Conflicts ------------------------------------------------------------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()
```

```r
library(broom)
library(lmerTest)
```

```
## Loading required package: lme4
```

```
## Loading required package: Matrix
```

```
## 
## Attaching package: 'Matrix'
```

```
## The following object is masked from 'package:tidyr':
## 
##     expand
```

```
## Loading required package: methods
```

```
## 
## Attaching package: 'lmerTest'
```

```
## The following object is masked from 'package:lme4':
## 
##     lmer
```

```
## The following object is masked from 'package:stats':
## 
##     step
```


```r
#bring in subject info (generated by 03_STOPPD_masterDF.Rmd)
# then take only the subjects who completed (n= 72 - note two were excluded for IF)
df <- read_csv('../generated_csvs/STOPPD_masterDF_2018-11-05.csv') %>%
  mutate(STUDYID = as.character(STUDYID)) %>%
  filter(second_complete == "Yes", MR_exclusion == "No") 

#rename timepoint variable for clarity
colnames(df)[colnames(df)=="second_timepoint"] <- "category" 

#make a datediff column for time between scans
df$dateDiff <- as.numeric(round(difftime(df$second_date, df$first_date, units = "days"), 0))

RandomArmColors = c( "#FFC200", "#007aa3")
```
## Known exclusion reasons

#### known DWI issues

**subject 410012 timepoint 02** -> scan was blacklisted "aborted" for system failure..no DWI for this participant

**subject 220009_timepoint 01** -> scan was also incomplete (this participant was only able complete the T1w)

So we will filter the data table to exclude these 2 participants (final n=71)


```r
df <- filter(df, !(STUDYID %in% c("410012", "220009")))
```

## mangling the Mean Diffusivity cata data

Erin reran the enigma DTI pipeline for only PMC using a different skull stripping parameter (-fa 0.7 to BET). We will use these numbers instead of the others in the archive here..


```r
#bring in FA data (from the filesystem)
FA_most <- read_csv('../data/enigma-DTI_archive_201811/enigmaDTI-FA-results.csv')
FA_PMC <- read_csv('../data/enigma-DTI_PMCredo_201809/enigmaDTI-FA-results.csv')

# separate id into it's parts and then drop old PMC data
FA_most <- FA_most %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  filter(site != "PMC")

# separate the PMC subject id into it's parts and then bind to the data from the other sites 
FA <- FA_PMC %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  bind_rows(FA_most)

# drop acute ("00") and other ("03") timepoints from the analysis
FA <- FA %>% 
  filter(!(timepoint %in% c("00", "03"))) %>%
  gather(tract, FA, ends_with("FA")) %>%
  spread(timepoint, FA) %>%
  mutate(change = `02` - `01`) %>%
  gather(timepoint, FA, `01`, `02`, change) %>%
  unite(tract_timepoint, tract, timepoint) %>%
  spread(tract_timepoint, FA)

rm(FA_most, FA_PMC)
```


## check for missing FA data


```r
# filter the master spreadsheet for the list of completers (no output means we are ok)
df %>%
  anti_join(FA, by = "STUDYID") %>%
  summarise(`Number of missing FA values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing FA values\\
\hline
0\\
\hline
\end{tabular}

## merge (i.e. join) the FA data with the clinical scores 


```r
all_FA <- df %>%
  select(STUDYID, sex, age, randomization, category, dateDiff) %>%
  mutate(RandomArm = factor(randomization, 
                       levels = c("O", "P"),
                       labels = c("Olanzapine", "Placebo"))) %>%
  left_join(FA, by = "STUDYID")

all_FA %>%
  filter(is.na(AverageFA_FA_01)) %>%
  summarise(`Number of missing timepoint 1 FA values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing timepoint 1 FA values\\
\hline
0\\
\hline
\end{tabular}

```r
all_FA %>%
  filter(is.na(AverageFA_FA_02)) %>%
  summarise(`Number of missing timepoint 2 FA values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing timepoint 2 FA values\\
\hline
0\\
\hline
\end{tabular}


```r
#write out clean FA speadsheet (required for subsequent FA analyses)
write.csv(all_FA, '../generated_csvs/STOPPD_FAclean.csv', row.names = FALSE)
```






## Running Table One to get baseline values


```r
library(tableone)
CreateTableOne(data = all_FA,
               strata = c("RandomArm"),
               vars = c("category", "AverageFA_FA_01"))
```

```
##                              Stratified by RandomArm
##                               Olanzapine   Placebo      p      test
##   n                             37           34                    
##   category (%)                                           0.004     
##      Off protocol                4 (10.8)     1 ( 2.9)             
##      RCT                        26 (70.3)    14 (41.2)             
##      Relapse                     7 (18.9)    19 (55.9)             
##   AverageFA_FA_01 (mean (sd)) 0.39 (0.03)  0.38 (0.03)   0.130
```

#### baseline collapsed value


```r
CreateTableOne(data = all_FA,
               vars = c("category", "AverageFA_FA_01"))
```

```
##                              
##                               Overall     
##   n                             71        
##   category (%)                            
##      Off protocol                5 ( 7.0) 
##      RCT                        40 (56.3) 
##      Relapse                    26 (36.6) 
##   AverageFA_FA_01 (mean (sd)) 0.38 (0.03)
```

#### baseline t.test


```r
all_FA %>%
  select(RandomArm, AverageFA_FA_01) %>%
  gather(brain, mm, -RandomArm) %>%
  group_by(brain) %>%
  do(tidy(t.test(mm~RandomArm, data = .))) %>%
  select(brain, statistic, parameter, p.value, method) %>%
  rename(t = statistic, df = parameter) %>%
  knitr::kable(caption = "t.test for baseline group differences", digits = 2)
```

\begin{table}[t]

\caption{(\#tab:unnamed-chunk-9)t.test for baseline group differences}
\centering
\begin{tabular}{l|r|r|r|l}
\hline
brain & t & df & p.value & method\\
\hline
AverageFA\_FA\_01 & 1.54 & 68.8 & 0.13 & Welch Two Sample t-test\\
\hline
\end{tabular}
\end{table}

Note that there are very strong scanner effects so it is probably better to consider these by site..


```r
CreateTableOne(data = all_FA,
               strata = c("RandomArm","site"),
               vars = c("category", "AverageFA_FA_01"))
```

```
##                              Stratified by RandomArm:site
##                               Olanzapine:CMH Placebo:CMH  Olanzapine:MAS
##   n                             18             11            7          
##   category (%)                                                          
##      Off protocol                3 (16.7)       1 ( 9.1)     0 ( 0.0)   
##      RCT                        12 (66.7)       5 (45.5)     4 (57.1)   
##      Relapse                     3 (16.7)       5 (45.5)     3 (42.9)   
##   AverageFA_FA_01 (mean (sd)) 0.42 (0.02)    0.41 (0.02)  0.37 (0.01)   
##                              Stratified by RandomArm:site
##                               Placebo:MAS  Olanzapine:NKI Placebo:NKI 
##   n                             10            6              7        
##   category (%)                                                        
##      Off protocol                0 ( 0.0)     0 (  0.0)      0 ( 0.0) 
##      RCT                         4 (40.0)     6 (100.0)      3 (42.9) 
##      Relapse                     6 (60.0)     0 (  0.0)      4 (57.1) 
##   AverageFA_FA_01 (mean (sd)) 0.37 (0.02)  0.36 (0.03)    0.35 (0.02) 
##                              Stratified by RandomArm:site
##                               Olanzapine:PMC Placebo:PMC  p      test
##   n                              6              6                    
##   category (%)                                             0.180     
##      Off protocol                1 (16.7)       0 ( 0.0)             
##      RCT                         4 (66.7)       2 (33.3)             
##      Relapse                     1 (16.7)       4 (66.7)             
##   AverageFA_FA_01 (mean (sd)) 0.35 (0.01)    0.36 (0.02)  <0.001
```

## RCT only


```r
#boxplot of difference in FA in whole skeleton (y axis) by randomization group (x axis)
ggplot(RCT_FA, aes(x= RandomArm, y = diffAverageSkel_FA, fill = RandomArm)) + 
   geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
   geom_dotplot(binaxis = 'y', stackdir = 'center') +
   geom_hline(yintercept = 0) +
   xlab(NULL) +  
   ylab("Change in Fractional Anisotropy") +
   scale_fill_manual(values = RandomArmColors) +
   scale_shape_manual(values = c(21)) +
   theme_bw()
```

```
## `stat_bindot()` using `bins = 30`. Pick better value with `binwidth`.
```

![](08_STOPPD_FA-meanFAskel_files/figure-latex/RCT_FA_meanSkel_plot_fig3A-1.pdf)<!-- --> 



```r
#run linear model with covariates of sex, age and site
fit_rct <- lmer(diffAverageSkel_FA ~ RandomArm + sex + age + (1|site), data= RCT_FA)
summary(fit_rct)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: diffAverageSkel_FA ~ RandomArm + sex + age + (1 | site)
##    Data: RCT_FA
## 
## REML criterion at convergence: -234.8
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.41668 -0.51246  0.05053  0.61252  2.31072 
## 
## Random effects:
##  Groups   Name        Variance                      Std.Dev.        
##  site     (Intercept) 0.000000000000000000000001416 0.00000000000119
##  Residual             0.000053583148415937287148761 0.00732005112113
## Number of obs: 40, groups:  site, 4
## 
## Fixed effects:
##                     Estimate  Std. Error          df t value Pr(>|t|)  
## (Intercept)       0.00666412  0.00459470 36.00000000   1.450   0.1556  
## RandomArmPlacebo  0.00177238  0.00246851 36.00000000   0.718   0.4774  
## sexM              0.00304198  0.00237628 36.00000000   1.280   0.2087  
## age              -0.00020489  0.00008522 36.00000000  -2.404   0.0215 *
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP sexM  
## RndmArmPlcb -0.022              
## sexM        -0.044  0.067       
## age         -0.921 -0.181 -0.201
```
## adding the non-RCT people to the plot


```r
all_FA %>%
  mutate(Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  ggplot(aes(x= RandomArm, y = diffAverageSkel_FA, fill = Outcome)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center', 
                  position=position_dodge(0.8)) +
     geom_hline(yintercept = 0) +
     xlab(NULL) +
     ylab("change in FA between scans") +
     theme_bw() +
     scale_fill_manual(values = c('white','grey')) 
```

```
## `stat_bindot()` using `bins = 30`. Pick better value with `binwidth`.
```

![](08_STOPPD_FA-meanFAskel_files/figure-latex/unnamed-chunk-11-1.pdf)<!-- --> 


```r
all_FA %>%
  mutate(Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  filter(category != "Off protocol") %>%
  group_by(RandomArm, category) %>%
  do(tidy(t.test(.$diffAverageSkel_FA, mu = 0, alternative = "two.sided"))) %>%
  knitr::kable(digits = 3)
```


\begin{tabular}{l|l|r|r|r|r|r|r|l|l}
\hline
RandomArm & category & estimate & statistic & p.value & parameter & conf.low & conf.high & method & alternative\\
\hline
Olanzapine & RCT & -0.003 & -1.667 & 0.108 & 25 & -0.006 & 0.001 & One Sample t-test & two.sided\\
\hline
Olanzapine & Relapse & 0.002 & 1.174 & 0.285 & 6 & -0.002 & 0.007 & One Sample t-test & two.sided\\
\hline
Placebo & RCT & -0.002 & -1.055 & 0.311 & 13 & -0.006 & 0.002 & One Sample t-test & two.sided\\
\hline
Placebo & Relapse & 0.003 & 1.642 & 0.118 & 18 & -0.001 & 0.006 & One Sample t-test & two.sided\\
\hline
\end{tabular}


## RCT & Relapse (with time as factor)



```r
RCTRelapse_wholeskelFA <- RCTRelapse_FA %>%
  filter(Tract == "AverageFA") %>%
  mutate(category = factor(category, levels = c("RCT","Relapse", "Off protocol")))
#plot
RCTRelapse_wholeskelFA %>%
  ggplot(aes(x=model_days, y=FA, fill = RandomArm)) + 
  geom_point(aes(shape = category)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", formula=y~poly(x,1)) +
  xlab("Days between MRIs") +  
  ylab("Fractional Anistotropy") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw()
```

![](08_STOPPD_FA-meanFAskel_files/figure-latex/RCTRelapse_FA_plot_fig3C-1.pdf)<!-- --> 


```r
RCTRelapse_wholeskelFA <- RCTRelapse_FA %>%
  filter(Tract == "AverageFA")
```




```r
#run mixed linear model, with covariates
fit_all <- lmer(FA ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data= RCTRelapse_wholeskelFA)
summary(fit_all)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: 
## FA ~ RandomArm * model_days + sex + age + (1 | site) + (1 | STUDYID)
##    Data: RCTRelapse_wholeskelFA
## 
## REML criterion at convergence: -775.2
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.21982 -0.35896  0.00547  0.39988  1.97798 
## 
## Random effects:
##  Groups   Name        Variance   Std.Dev.
##  STUDYID  (Intercept) 0.00026598 0.016309
##  site     (Intercept) 0.00070535 0.026558
##  Residual             0.00002933 0.005416
## Number of obs: 142, groups:  STUDYID, 71; site, 4
## 
## Fixed effects:
##                                 Estimate   Std. Error           df t value
## (Intercept)                  0.407631799  0.015434155  5.236419521  26.411
## RandomArmPlacebo            -0.001841260  0.004141270 69.083333079  -0.445
## model_days                  -0.000006488  0.000005707 69.766731348  -1.137
## sexM                         0.007365517  0.004061284 64.109601146   1.814
## age                         -0.000643375  0.000131280 64.097168345  -4.901
## RandomArmPlacebo:model_days  0.000002427  0.000009590 70.910670616   0.253
##                                Pr(>|t|)    
## (Intercept)                 0.000000895 ***
## RandomArmPlacebo                 0.6580    
## model_days                       0.2594    
## sexM                             0.0744 .  
## age                         0.000006817 ***
## RandomArmPlacebo:model_days      0.8009    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP mdl_dy sexM   age   
## RndmArmPlcb -0.109                            
## model_days  -0.044  0.144                     
## sexM        -0.099  0.071  0.004              
## age         -0.451 -0.076  0.008 -0.086       
## RndmArmPl:_  0.024 -0.190 -0.595  0.002 -0.002
```


```r
#run mixed linear model, with covariates
RCTRelapse_wholeskelFA_sense <- RCTRelapse_wholeskelFA %>% filter(category != "Off protocol")

fit_all <- lmer(FA ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data= RCTRelapse_wholeskelFA_sense)
summary(fit_all)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: 
## FA ~ RandomArm * model_days + sex + age + (1 | site) + (1 | STUDYID)
##    Data: RCTRelapse_wholeskelFA_sense
## 
## REML criterion at convergence: -716.1
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.25703 -0.35536  0.00513  0.38574  1.96192 
## 
## Random effects:
##  Groups   Name        Variance   Std.Dev.
##  STUDYID  (Intercept) 0.00027717 0.016648
##  site     (Intercept) 0.00069513 0.026365
##  Residual             0.00002769 0.005262
## Number of obs: 132, groups:  STUDYID, 66; site, 4
## 
## Fixed effects:
##                                 Estimate   Std. Error           df t value
## (Intercept)                  0.407253648  0.015507242  5.452825329  26.262
## RandomArmPlacebo            -0.003422358  0.004344248 63.413298187  -0.788
## model_days                  -0.000008731  0.000005756 64.532321497  -1.517
## sexM                         0.007097355  0.004309842 59.104600046   1.647
## age                         -0.000612219  0.000139000 59.089659708  -4.404
## RandomArmPlacebo:model_days  0.000004781  0.000009453 65.474883036   0.506
##                                Pr(>|t|)    
## (Intercept)                 0.000000595 ***
## RandomArmPlacebo                  0.434    
## model_days                        0.134    
## sexM                              0.105    
## age                         0.000045244 ***
## RandomArmPlacebo:model_days       0.615    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) RndmAP mdl_dy sexM   age   
## RndmArmPlcb -0.114                            
## model_days  -0.045  0.142                     
## sexM        -0.071  0.029 -0.001              
## age         -0.466 -0.071  0.011 -0.134       
## RndmArmPl:_  0.028 -0.185 -0.609  0.007 -0.007
```


## running exploratory Tractwise analysis

No significant effects found


```r
RCT_Tractwise <- RCT_FA %>%
  gather(elabel, change_FA, ends_with('_FA_change')) %>%
  filter(!str_detect(elabel, '-L'), 
         !str_detect(elabel, '-R'),
         !str_detect(elabel, 'Average')) %>%
  group_by(elabel) %>%
  do(tidy(lm(change_FA ~ RandomArm + sex + age + site, data= .))) %>%
  ungroup() %>% group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = 'fdr'))

RCT_Tractwise %>%
  filter(p_FDR < 0.1) %>%
  arrange(p.value) %>%
  knitr::kable()
```


\begin{tabular}{l|l|r|r|r|r|r}
\hline
elabel & term & estimate & std.error & statistic & p.value & p\_FDR\\


\hline
\end{tabular}


```r
#cleanup
rm('df', 'fit_all', 'fit_rct', 'FA', 'plot', 'RCT_FA', 'RCTRelapse_FA')
```

```
## Warning in rm("df", "fit_all", "fit_rct", "FA", "plot", "RCT_FA",
## "RCTRelapse_FA"): object 'plot' not found
```

