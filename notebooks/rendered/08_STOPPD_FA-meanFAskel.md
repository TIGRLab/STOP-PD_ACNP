# Whole Skeleton Fractional Anisotropy 


```r
#load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(growthmodels)
```


```r
#bring in subject info (generated by 03_STOPPD_masterDF.Rmd)
# then take only the subjects who completed (n= 72 - note two were excluded for IF)
df <- read_csv('../generated_csvs/STOPPD_masterDF_2018-11-05.csv') %>%
  mutate(STUDYID = as.character(STUDYID)) %>%
  filter(second_complete == "Yes", MR_exclusion == "No") 

#rename timepoint variable for clarity
colnames(df)[colnames(df)=="second_timepoint"] <- "category" 

#make a datediff column for time between scans
df$dateDiff <- as.numeric(round(difftime(df$second_date, df$first_date, units = "days"), 0))
```
## Known exclusion reasons

#### known DWI issues

**subject 410012 timepoint 02** -> scan was blacklisted "aborted" for system failure..no DWI for this participant

**subject 220009_timepoint 01** -> scan was also incomplete (this participant was only able complete the T1w)

So we will filter the data table to exclude these 2 participants (final n=71)


```r
df <- filter(df, !(STUDYID %in% c("410012", "220009")))
```

## mangling the Mean Diffusivity cata data

Erin reran the enigma DTI pipeline for only PMC using a different skull stripping parameter (-fa 0.7 to BET). We will use these numbers instead of the others in the archive here..


```r
#bring in FA data (from the filesystem)
FA_most <- read_csv('../data/enigma-DTI_archive_201811/enigmaDTI-FA-results.csv')
FA_PMC <- read_csv('../data/enigma-DTI_PMCredo_201809/enigmaDTI-FA-results.csv')

# separate id into it's parts and then drop old PMC data
FA_most <- FA_most %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  filter(site != "PMC")

# separate the PMC subject id into it's parts and then bind to the data from the other sites 
FA <- FA_PMC %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  bind_rows(FA_most)

# drop acute ("00") and other ("03") timepoints from the analysis
FA <- FA %>% 
  filter(!(timepoint %in% c("00", "03"))) %>%
  gather(tract, FA, ends_with("FA")) %>%
  unite(tract_timepoint, tract, timepoint) %>%
  spread(tract_timepoint, FA)
```


## check for missing FA data


```r
# filter the master spreadsheet for the list of completers (no output means we are ok)
df %>%
  anti_join(FA, by = "STUDYID") %>%
  summarise(`Number of missing FA values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing FA values\\
\hline
0\\
\hline
\end{tabular}

## merge (i.e. join) the FA data with the clinical scores 


```r
all_FA <- df %>%
  select(STUDYID, sex, age, randomization, category, dateDiff) %>%
  left_join(FA, by = "STUDYID")

all_FA %>%
  filter(is.na(AverageFA_FA_01)) %>%
  summarise(`Number of missing timepoint 1 FA values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing timepoint 1 FA values\\
\hline
0\\
\hline
\end{tabular}

```r
all_FA %>%
  filter(is.na(AverageFA_FA_02)) %>%
  summarise(`Number of missing timepoint 2 FA values` = n()) %>%
  knitr::kable()
```


\begin{tabular}{r}
\hline
Number of missing timepoint 2 FA values\\
\hline
0\\
\hline
\end{tabular}


```r
#write out clean FA speadsheet (required for subsequent FA analyses)
write.csv(all_FA, '../generated_csvs/STOPPD_FAclean.csv', row.names = FALSE)
```





## RCT only


```r
#boxplot of difference in FA in whole skeleton (y axis) by randomization group (x axis)
ggplot(RCT_FA, aes(x= randomization, y = diffAverageSkel_FA)) + 
   geom_boxplot(outlier.shape = NA) + 
   geom_dotplot(binaxis = 'y', stackdir = 'center') +
   geom_hline(yintercept = 0) +
   ggtitle("Whole skeleton fractional anisotropy") +
   xlab("randomization condition") +  
   ylab("difference between timepoints") +
   theme_minimal()
```

```
## `stat_bindot()` using `bins = 30`. Pick better value with `binwidth`.
```

![](08_STOPPD_FA-meanFAskel_files/figure-latex/RCT_FA_meanSkel_plot-1.pdf)<!-- --> 



```r
fit_rct <- lm(diffAverageSkel_FA ~ randomization, data= RCT_FA)
print(fit_rct)
```

```
## 
## Call:
## lm(formula = diffAverageSkel_FA ~ randomization, data = RCT_FA)
## 
## Coefficients:
##    (Intercept)  randomizationP  
##     -0.0026337       0.0006364
```

```r
summary(fit_rct)
```

```
## 
## Call:
## lm(formula = diffAverageSkel_FA ~ randomization, data = RCT_FA)
## 
## Residuals:
##        Min         1Q     Median         3Q        Max 
## -0.0182273 -0.0032754  0.0007225  0.0043244  0.0190097 
## 
## Coefficients:
##                  Estimate Std. Error t value Pr(>|t|)  
## (Intercept)    -0.0026337  0.0015172  -1.736   0.0907 .
## randomizationP  0.0006364  0.0025645   0.248   0.8054  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.007736 on 38 degrees of freedom
## Multiple R-squared:  0.001618,	Adjusted R-squared:  -0.02466 
## F-statistic: 0.06158 on 1 and 38 DF,  p-value: 0.8054
```

```r
#run linear model with covariates of sex and age
fit_rct <- lm(diffAverageSkel_FA ~ randomization + sex + age, data= RCT_FA)
print(fit_rct)
```

```
## 
## Call:
## lm(formula = diffAverageSkel_FA ~ randomization + sex + age, 
##     data = RCT_FA)
## 
## Coefficients:
##    (Intercept)  randomizationP            sexM             age  
##      0.0066641       0.0017724       0.0030420      -0.0002049
```

```r
summary(fit_rct)
```

```
## 
## Call:
## lm(formula = diffAverageSkel_FA ~ randomization + sex + age, 
##     data = RCT_FA)
## 
## Residuals:
##        Min         1Q     Median         3Q        Max 
## -0.0176902 -0.0037512  0.0003699  0.0044837  0.0169146 
## 
## Coefficients:
##                   Estimate  Std. Error t value Pr(>|t|)  
## (Intercept)     0.00666412  0.00459470   1.450   0.1556  
## randomizationP  0.00177238  0.00246851   0.718   0.4774  
## sexM            0.00304198  0.00237628   1.280   0.2087  
## age            -0.00020489  0.00008522  -2.404   0.0215 *
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.00732 on 36 degrees of freedom
## Multiple R-squared:  0.1531,	Adjusted R-squared:  0.08256 
## F-statistic:  2.17 on 3 and 36 DF,  p-value: 0.1085
```

```r
#run linear model with covariates of sex, age and site
fit_rct <- lm(diffAverageSkel_FA ~ randomization + sex + age + site, data= RCT_FA)
print(fit_rct)
```

```
## 
## Call:
## lm(formula = diffAverageSkel_FA ~ randomization + sex + age + 
##     site, data = RCT_FA)
## 
## Coefficients:
##    (Intercept)  randomizationP            sexM             age  
##      0.0055312       0.0011892       0.0024924      -0.0002075  
##        siteMAS         siteNKI         sitePMC  
##      0.0048105       0.0015693       0.0027403
```

```r
summary(fit_rct)
```

```
## 
## Call:
## lm(formula = diffAverageSkel_FA ~ randomization + sex + age + 
##     site, data = RCT_FA)
## 
## Residuals:
##        Min         1Q     Median         3Q        Max 
## -0.0164312 -0.0039600  0.0001338  0.0050820  0.0187285 
## 
## Coefficients:
##                   Estimate  Std. Error t value Pr(>|t|)  
## (Intercept)     0.00553120  0.00519594   1.065   0.2948  
## randomizationP  0.00118917  0.00254062   0.468   0.6428  
## sexM            0.00249237  0.00243729   1.023   0.3139  
## age            -0.00020752  0.00009488  -2.187   0.0359 *
## siteMAS         0.00481051  0.00324006   1.485   0.1471  
## siteNKI         0.00156932  0.00309643   0.507   0.6157  
## sitePMC         0.00274025  0.00380401   0.720   0.4764  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.00739 on 33 degrees of freedom
## Multiple R-squared:  0.2089,	Adjusted R-squared:  0.06501 
## F-statistic: 1.452 on 6 and 33 DF,  p-value: 0.2251
```

## RCT & Relapse (with time as factor)



```r
RCTRelapse_wholeskelFA <- RCTRelapse_FA %>%
  filter(Tract == "AverageFA")
#plot
RCTRelapse_wholeskelFA %>%
  ggplot(aes(x=model_days, y=FA, colour=randomization)) + 
  geom_point() + 
  geom_line(aes(group=STUDYID), alpha = 0.5) + 
  geom_smooth(method="lm", formula=y~poly(x,1)) +
  ggtitle("Whole skeleton fractional anisotropy over time") +    
  xlab("days between MRIs") +  
  ylab("Mean Diffusivity") +
  theme_minimal()
```

![](08_STOPPD_FA-meanFAskel_files/figure-latex/RCTRelapse_FA_plot-1.pdf)<!-- --> 


```r
#run mixed linear model, with covariates
fit_all <- lmer(FA ~ randomization*model_days + sex + age + (1|STUDYID), data= RCTRelapse_wholeskelFA)
summary(fit_all)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: FA ~ randomization * model_days + sex + age + (1 | STUDYID)
##    Data: RCTRelapse_wholeskelFA
## 
## REML criterion at convergence: -705.9
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.94972 -0.36140 -0.01493  0.37639  2.03848 
## 
## Random effects:
##  Groups   Name        Variance   Std.Dev.
##  STUDYID  (Intercept) 0.00091790 0.030297
##  Residual             0.00002934 0.005417
## Number of obs: 142, groups:  STUDYID, 71
## 
## Fixed effects:
##                               Estimate   Std. Error           df t value
## (Intercept)                0.420038504  0.014072666 67.294984696  29.848
## randomizationP            -0.010187596  0.007320306 68.631328224  -1.392
## model_days                -0.000006710  0.000005717 69.240746206  -1.174
## sexM                      -0.000889927  0.007300269 67.001340480  -0.122
## age                       -0.000570356  0.000237119 67.001860376  -2.405
## randomizationP:model_days  0.000002899  0.000009637 69.582543938   0.301
##                                      Pr(>|t|)    
## (Intercept)               <0.0000000000000002 ***
## randomizationP                         0.1685    
## model_days                             0.2446    
## sexM                                   0.9033    
## age                                    0.0189 *  
## randomizationP:model_days              0.7644    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) rndmzP mdl_dy sexM   age   
## randomiztnP -0.205                            
## model_days  -0.047  0.082                     
## sexM        -0.174  0.050  0.002              
## age         -0.899 -0.061  0.004 -0.085       
## rndmztnP:m_  0.026 -0.108 -0.593  0.002 -0.001
```
## just wanna through in one site model..


```r
#run mixed linear model, with covariates
fit_all <- lmer(FA ~ randomization*model_days + sex + age + site + (1|STUDYID), data= RCTRelapse_wholeskelFA)
summary(fit_all)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: 
## FA ~ randomization * model_days + sex + age + site + (1 | STUDYID)
##    Data: RCTRelapse_wholeskelFA
## 
## REML criterion at convergence: -763.4
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.22673 -0.36093  0.00773  0.40476  1.97403 
## 
## Random effects:
##  Groups   Name        Variance   Std.Dev.
##  STUDYID  (Intercept) 0.00026606 0.016311
##  Residual             0.00002933 0.005416
## Number of obs: 142, groups:  STUDYID, 71
## 
## Fixed effects:
##                               Estimate   Std. Error           df t value
## (Intercept)                0.446664113  0.008121600 64.854939100  54.997
## randomizationP            -0.001694241  0.004143105 68.953740506  -0.409
## model_days                -0.000006481  0.000005707 69.765390246  -1.136
## sexM                       0.007528548  0.004063003 64.002130344   1.853
## age                       -0.000644155  0.000131327 64.007125598  -4.905
## siteMAS                   -0.045128486  0.005245359 64.005598123  -8.604
## siteNKI                   -0.054431216  0.005671919 64.015089285  -9.597
## sitePMC                   -0.057667867  0.005835298 63.997753494  -9.883
## randomizationP:model_days  0.000002411  0.000009591 70.909497124   0.251
##                                       Pr(>|t|)    
## (Intercept)               < 0.0000000000000002 ***
## randomizationP                          0.6839    
## model_days                              0.2599    
## sexM                                    0.0685 .  
## age                         0.0000067266336686 ***
## siteMAS                     0.0000000000027939 ***
## siteNKI                     0.0000000000000519 ***
## sitePMC                     0.0000000000000168 ***
## randomizationP:model_days               0.8023    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr) rndmzP mdl_dy sexM   age    sitMAS sitNKI sitPMC
## randomiztnP -0.141                                                 
## model_days  -0.082  0.144                                          
## sexM        -0.126  0.072  0.004                                   
## age         -0.878 -0.076  0.009 -0.086                            
## siteMAS     -0.290 -0.172  0.005 -0.092  0.124                     
## siteNKI     -0.175 -0.122 -0.011 -0.122  0.013  0.355              
## sitePMC     -0.153 -0.091 -0.001 -0.146 -0.007  0.341  0.320       
## rndmztnP:m_  0.044 -0.190 -0.595  0.002 -0.002  0.002  0.010  0.003
```



```r
#cleanup
rm('df', 'fit_all', 'fit_rct', 'FA', 'plot', 'RCT_FA', 'RCTRelapse_FA')
```

```
## Warning in rm("df", "fit_all", "fit_rct", "FA", "plot", "RCT_FA",
## "RCTRelapse_FA"): object 'plot' not found
```

