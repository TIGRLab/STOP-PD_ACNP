# Whole Skeleton Fractional Anisotropy 

```{r set_up, message=FALSE, warning=FALSE}
#load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(growthmodels)
```

```{r message=FALSE, warning=FALSE}
#bring in subject info (generated by 03_STOPPD_masterDF.Rmd)
# then take only the subjects who completed (n= 72 - note two were excluded for IF)
df <- read_csv('../generated_csvs/STOPPD_masterDF_2018-11-05.csv') %>%
  mutate(STUDYID = as.character(STUDYID)) %>%
  filter(second_complete == "Yes", MR_exclusion == "No") 

#rename timepoint variable for clarity
colnames(df)[colnames(df)=="second_timepoint"] <- "category" 

#make a datediff column for time between scans
df$dateDiff <- as.numeric(round(difftime(df$second_date, df$first_date, units = "days"), 0))

```
## Known exclusion reasons

#### known DWI issues

**subject 410012 timepoint 02** -> scan was blacklisted "aborted" for system failure..no DWI for this participant

**subject 220009_timepoint 01** -> scan was also incomplete (this participant was only able complete the T1w)

So we will filter the data table to exclude these 2 participants (final n=71)

```{r}
df <- filter(df, !(STUDYID %in% c("410012", "220009")))
```

## mangling the Mean Diffusivity cata data

Erin reran the enigma DTI pipeline for only PMC using a different skull stripping parameter (-fa 0.7 to BET). We will use these numbers instead of the others in the archive here..

```{r FA_datacleaning_general, message=FALSE, warning=FALSE}
#bring in FA data (from the filesystem)
FA_most <- read_csv('../data/enigma-DTI_archive_201811/enigmaDTI-FA-results.csv')
FA_PMC <- read_csv('../data/enigma-DTI_PMCredo_201809/enigmaDTI-FA-results.csv')

# separate id into it's parts and then drop old PMC data
FA_most <- FA_most %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  filter(site != "PMC")

# separate the PMC subject id into it's parts and then bind to the data from the other sites 
FA <- FA_PMC %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  bind_rows(FA_most)

# drop acute ("00") and other ("03") timepoints from the analysis
FA <- FA %>% 
  filter(!(timepoint %in% c("00", "03"))) %>%
  gather(tract, FA, ends_with("FA")) %>%
  unite(tract_timepoint, tract, timepoint) %>%
  spread(tract_timepoint, FA)
```


## check for missing FA data

```{r}
# filter the master spreadsheet for the list of completers (no output means we are ok)
df %>%
  anti_join(FA, by = "STUDYID") %>%
  summarise(`Number of missing FA values` = n()) %>%
  knitr::kable()
```

## merge (i.e. join) the FA data with the clinical scores 

```{r}
all_FA <- df %>%
  select(STUDYID, sex, age, randomization, category, dateDiff) %>%
  left_join(FA, by = "STUDYID")

all_FA %>%
  filter(is.na(AverageFA_FA_01)) %>%
  summarise(`Number of missing timepoint 1 FA values` = n()) %>%
  knitr::kable()
```
```{r}
all_FA %>%
  filter(is.na(AverageFA_FA_02)) %>%
  summarise(`Number of missing timepoint 2 FA values` = n()) %>%
  knitr::kable()
```

```{r}
#write out clean FA speadsheet (required for subsequent FA analyses)
write.csv(all_FA, '../generated_csvs/STOPPD_FAclean.csv', row.names = FALSE)
```



```{r datacleaning, include = FALSE}

#turn off scientific notation
options(scipen = 999)

#make difference score
all_FA$diffAverageSkel_FA <- all_FA$AverageFA_FA_02 - all_FA$AverageFA_FA_01

#restructure data for RCT & Relapse participants (N=74)
RCTRelapse_FA <- all_FA %>%
  gather(oldcolname, FA, ends_with("FA_01"), ends_with("FA_02")) %>%
  separate(oldcolname, into = c("Tract", "metric_name", "timepoint"), sep = "_", fill = "left") %>%
  mutate(model_days = if_else(timepoint=="01", 1, dateDiff)) 

# filter data to only include the RCT completers in the first ana
RCT_FA <- all_FA %>%
  filter(category == "RCT")

#write out clean dataframe
#write.csv(RCT_FA, '../generated_data/df_FA_FA.csv', row.names=FALSE)

```

## RCT only

```{r RCT_FA_meanSkel_plot, warning = FALSE}
#boxplot of difference in FA in whole skeleton (y axis) by randomization group (x axis)
ggplot(RCT_FA, aes(x= randomization, y = diffAverageSkel_FA)) + 
   geom_boxplot(outlier.shape = NA) + 
   geom_dotplot(binaxis = 'y', stackdir = 'center') +
   geom_hline(yintercept = 0) +
   ggtitle("Whole skeleton fractional anisotropy") +
   xlab("randomization condition") +  
   ylab("difference between timepoints") +
   theme_minimal()

```


```{r RCT_FA_meanSkel_stats, warning = FALSE}
fit_rct <- lm(diffAverageSkel_FA ~ randomization, data= RCT_FA)
print(fit_rct)
summary(fit_rct)

#run linear model with covariates of sex and age
fit_rct <- lm(diffAverageSkel_FA ~ randomization + sex + age, data= RCT_FA)
print(fit_rct)
summary(fit_rct)

#run linear model with covariates of sex, age and site
fit_rct <- lm(diffAverageSkel_FA ~ randomization + sex + age + site, data= RCT_FA)
print(fit_rct)
summary(fit_rct)
```

## RCT & Relapse (with time as factor)


```{r RCTRelapse_FA_plot, warning = FALSE}
RCTRelapse_wholeskelFA <- RCTRelapse_FA %>%
  filter(Tract == "AverageFA")
#plot
RCTRelapse_wholeskelFA %>%
  ggplot(aes(x=model_days, y=FA, colour=randomization)) + 
  geom_point() + 
  geom_line(aes(group=STUDYID), alpha = 0.5) + 
  geom_smooth(method="lm", formula=y~poly(x,1)) +
  ggtitle("Whole skeleton fractional anisotropy over time") +    
  xlab("days between MRIs") +  
  ylab("Mean Diffusivity") +
  theme_minimal()
```

```{r RCTRelapse_FA_stats, warning = FALSE}
#run mixed linear model, with covariates
fit_all <- lmer(FA ~ randomization*model_days + sex + age + (1|STUDYID), data= RCTRelapse_wholeskelFA)
summary(fit_all)

```
## just wanna through in one site model..

```{r RCTRelapse_FA_statswsite, warning = FALSE}
#run mixed linear model, with covariates
fit_all <- lmer(FA ~ randomization*model_days + sex + age + site + (1|STUDYID), data= RCTRelapse_wholeskelFA)
summary(fit_all)
```


```{r FA-cleanup}
#cleanup
rm('df', 'fit_all', 'fit_rct', 'FA', 'plot', 'RCT_FA', 'RCTRelapse_FA')
```

