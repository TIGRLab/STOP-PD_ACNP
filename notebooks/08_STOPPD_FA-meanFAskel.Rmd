# Whole Skeleton Fractional Anisotropy 

```{r set_up}
#load libraries
library(tidyverse)
library(broom)
library(lmerTest)
```

```{r message=FALSE, warning=FALSE}
#bring in subject info (generated by 03_STOPPD_masterDF.Rmd)
# then take only the subjects who completed (n= 72 - note two were excluded for IF)
df <- read_csv('../generated_csvs/STOPPD_masterDF_2018-11-05.csv') %>%
  mutate(STUDYID = as.character(STUDYID)) %>%
  filter(second_complete == "Yes", MR_exclusion == "No") 

#rename timepoint variable for clarity
colnames(df)[colnames(df)=="second_timepoint"] <- "category" 

#make a datediff column for time between scans
df$dateDiff <- as.numeric(round(difftime(df$second_date, df$first_date, units = "days"), 0))

RandomArmColors = c("#e6ab02", "#386cb0")
```
## Known exclusion reasons

#### known DWI issues

**subject 410012 timepoint 02** -> scan was blacklisted "aborted" for system failure..no DWI for this participant

**subject 220009_timepoint 01** -> scan was also incomplete (this participant was only able complete the T1w)

So we will filter the data table to exclude these 2 participants (final n=71)

```{r}
df <- filter(df, !(STUDYID %in% c("410012", "220009")))
```

## mangling the Mean Diffusivity cata data

Erin reran the enigma DTI pipeline for only PMC using a different skull stripping parameter (-fa 0.7 to BET). We will use these numbers instead of the others in the archive here..

```{r FA_datacleaning_general, message=FALSE, warning=FALSE}
#bring in FA data (from the filesystem)
FA_most <- read_csv('../data/enigma-DTI_archive_201811/enigmaDTI-FA-results.csv')
FA_PMC <- read_csv('../data/enigma-DTI_PMCredo_201809/enigmaDTI-FA-results.csv')

# separate id into it's parts and then drop old PMC data
FA_most <- FA_most %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  filter(site != "PMC")

# separate the PMC subject id into it's parts and then bind to the data from the other sites 
FA <- FA_PMC %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  bind_rows(FA_most)

# drop acute ("00") and other ("03") timepoints from the analysis
FA <- FA %>% 
  filter(!(timepoint %in% c("00", "03"))) %>%
  gather(tract, FA, ends_with("FA")) %>%
  spread(timepoint, FA) %>%
  mutate(change = `02` - `01`) %>%
  gather(timepoint, FA, `01`, `02`, change) %>%
  unite(tract_timepoint, tract, timepoint) %>%
  spread(tract_timepoint, FA)

rm(FA_most, FA_PMC)
```


## check for missing FA data

```{r}
# filter the master spreadsheet for the list of completers (no output means we are ok)
df %>%
  anti_join(FA, by = "STUDYID") %>%
  summarise(`Number of missing FA values` = n()) %>%
  knitr::kable()
```

## merge (i.e. join) the FA data with the clinical scores 

```{r}
all_FA <- df %>%
  select(STUDYID, sex, age, randomization, category, dateDiff) %>%
  mutate(RandomArm = factor(randomization, 
                       levels = c("O", "P"),
                       labels = c("Olanzapine", "Placebo"))) %>%
  left_join(FA, by = "STUDYID")

all_FA %>%
  filter(is.na(AverageFA_FA_01)) %>%
  summarise(`Number of missing timepoint 1 FA values` = n()) %>%
  knitr::kable()
```
```{r}
all_FA %>%
  filter(is.na(AverageFA_FA_02)) %>%
  summarise(`Number of missing timepoint 2 FA values` = n()) %>%
  knitr::kable()
```

```{r}
#write out clean FA speadsheet (required for subsequent FA analyses)
write.csv(all_FA, '../generated_csvs/STOPPD_FAclean.csv', row.names = FALSE)
```



```{r datacleaning, include = FALSE}

#turn off scientific notation
options(scipen = 999)

#make difference score
all_FA$diffAverageSkel_FA <- all_FA$AverageFA_FA_02 - all_FA$AverageFA_FA_01

#restructure data for RCT & Relapse participants (N=74)
RCTRelapse_FA <- all_FA %>%
  gather(oldcolname, FA, ends_with("FA_01"), ends_with("FA_02")) %>%
  separate(oldcolname, into = c("Tract", "metric_name", "timepoint"), sep = "_", fill = "left") %>%
  mutate(model_days = if_else(timepoint=="01", 1, dateDiff)) 

# filter data to only include the RCT completers in the first ana
RCT_FA <- all_FA %>%
  filter(category == "RCT")

#write out clean dataframe
#write.csv(RCT_FA, '../generated_data/df_FA_FA.csv', row.names=FALSE)

```


## Running Table One to get baseline values

```{r}
library(tableone)
CreateTableOne(data = all_FA,
               strata = c("RandomArm"),
               vars = c("category", "AverageFA_FA_01"))
```

#### baseline collapsed value

```{r}
CreateTableOne(data = all_FA,
               vars = c("category", "AverageFA_FA_01"))
```

#### baseline t.test

```{r}
all_FA %>%
  select(RandomArm, AverageFA_FA_01) %>%
  gather(brain, mm, -RandomArm) %>%
  group_by(brain) %>%
  do(tidy(t.test(mm~RandomArm, data = .))) %>%
  select(brain, statistic, parameter, p.value, method) %>%
  rename(t = statistic, df = parameter) %>%
  knitr::kable(caption = "t.test for baseline group differences", digits = 2)
```

Note that there are very strong scanner effects so it is probably better to consider these by site..

```{r}

CreateTableOne(data = all_FA,
               strata = c("RandomArm","site"),
               vars = c("category", "AverageFA_FA_01"))
```

## RCT only

```{r RCT_FA_meanSkel_plot_fig3A, warning = FALSE, fig.width=4, fig.height=4}
#boxplot of difference in FA in whole skeleton (y axis) by randomization group (x axis)
ggplot(RCT_FA, aes(x= RandomArm, y = diffAverageSkel_FA, fill = RandomArm)) + 
   geom_boxplot(outlier.shape = NA, alpha = 0.0001) + 
   geom_dotplot(binaxis = 'y', stackdir = 'center') +
   geom_hline(yintercept = 0) +
   labs(x = NULL, y = "Change in Fractional Anisotropy",
        fill = "Group") +
   scale_fill_manual(values = RandomArmColors) +
   scale_shape_manual(values = c(21)) +
   theme_bw() +
   theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())
```


```{r RCT_FA_meanSkel_stats, warning = FALSE}
#run linear model with covariates of sex, age and site
fit_rct <- lmer(diffAverageSkel_FA ~ RandomArm + sex + age + (1|site), data= RCT_FA)
summary(fit_rct)
```
## adding the non-RCT people to the plot

```{r}
all_FA %>%
  mutate(Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  ggplot(aes(x= RandomArm, y = diffAverageSkel_FA, fill = Outcome)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center', 
                  position=position_dodge(0.8)) +
     geom_hline(yintercept = 0) +
     xlab(NULL) +
     ylab("change in FA between scans") +
     theme_bw() +
     scale_fill_manual(values = c('white','grey')) 
```

```{r}
all_FA %>%
  mutate(Outcome = case_when(category == "Off protocol" ~ "non-completer",
                             category == "Relapse" ~ "non-completer",
                             category == "RCT"~ "completer")) %>%
  filter(category != "Off protocol") %>%
  group_by(RandomArm, category) %>%
  do(tidy(t.test(.$diffAverageSkel_FA, mu = 0, alternative = "two.sided"))) %>%
  knitr::kable(digits = 3)
```


## RCT & Relapse (with time as factor)


```{r RCTRelapse_FA_plot_fig3C, fig.width=4.75, fig.height=4}
RCTRelapse_wholeskelFA <- RCTRelapse_FA %>%
  filter(Tract == "AverageFA") %>%
  mutate(category = factor(category, levels = c("RCT","Relapse", "Off protocol"),
                           labels = c("Sustained remission", "Relapse", "Discontinuation")))
#plot
RCTRelapse_wholeskelFA %>%
  ggplot(aes(x=model_days, y=FA, fill = RandomArm)) + 
  geom_point(aes(shape = category)) + 
  geom_line(aes(group=STUDYID, color = RandomArm), alpha = 0.5) + 
  geom_smooth(aes(color = RandomArm), method="lm", fill = "grey40") +
  labs(x ="Days between MRIs", 
       y = "Fractional Anistotropy",
       shape = "Status at scan 2",
       color = "Group") +
  scale_colour_manual(values = RandomArmColors) +
  scale_fill_manual(values = RandomArmColors) +
  scale_shape_manual(values = c(21:23)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(), panel.grid.major = element_blank())
```

```{r RCTRelapse_FA_plot, warning = FALSE}
RCTRelapse_wholeskelFA <- RCTRelapse_FA %>%
  filter(Tract == "AverageFA")

```



```{r RCTRelapse_FA_statswsite1}
#run mixed linear model, with covariates
fit_all <- lmer(FA ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data= RCTRelapse_wholeskelFA)
summary(fit_all)
```

```{r RCTRelapse_FA_statswsite1_sense}
#run mixed linear model, with covariates
RCTRelapse_wholeskelFA_sense <- RCTRelapse_wholeskelFA %>% filter(category != "Off protocol")

fit_all <- lmer(FA ~ RandomArm*model_days + sex + age + (1|site) + (1|STUDYID), data= RCTRelapse_wholeskelFA_sense)
summary(fit_all)
```


## running exploratory Tractwise analysis

No significant effects found

```{r}
RCT_Tractwise <- RCT_FA %>%
  gather(elabel, change_FA, ends_with('_FA_change')) %>%
  filter(!str_detect(elabel, '-L'), 
         !str_detect(elabel, '-R'),
         !str_detect(elabel, 'Average')) %>%
  group_by(elabel) %>%
  do(tidy(lm(change_FA ~ RandomArm + sex + age + site, data= .))) %>%
  ungroup() %>% group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = 'fdr'))

RCT_Tractwise %>%
  filter(p_FDR < 0.1) %>%
  arrange(p.value) %>%
  knitr::kable()

```

```{r FA-cleanup}
#cleanup
rm('df', 'fit_all', 'fit_rct', 'FA', 'plot', 'RCT_FA', 'RCTRelapse_FA')
```

