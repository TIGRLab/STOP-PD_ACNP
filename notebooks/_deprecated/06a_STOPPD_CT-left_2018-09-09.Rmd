---
title: |
  | <br><br><br><br>STOPPD cortical thickness analysis
  | (left hemisphere only)
written: 2018-03-08
edited: 2018-11-09
lastrun: Sys.Date()
output: 
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 2
---

#This script analyses cortical thickness in the left hemisphere. 

```{r set_up, message=FALSE, warning=FALSE}

#load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(growthmodels)


#bring in data 
df <- read_csv('../generated_csvs/STOPPD_participantsCT_20181111.csv') #generated by 05_STOPPD_error in prepartion of Jason Lerch meeting


```


```{r}
#make sure that STUDYID is an interger not a number
  df$STUDYID <- as.character(df$STUDYID)

#make sure that dateDiff is a number, not an interger
  df$dateDiff <- as.numeric(df$dateDiff)

# label the randomization variable  
df$RandomArm <- factor(df$randomization, 
                       levels = c("O", "P"),
                       labels = c("Olanzapine", "Placebo"))

#restructure data for RCT completers' only (N=40)
  RCT_CT <- df %>%
    filter(category == "RCT") 



#write out clean dataframe
 # write.csv(RCT_CT, '../generated_data/df_leftCT.csv', row.names=FALSE)

```


## RCT only



```{r RCT_LCT_boxplot}
RCT_CT %>% count(randomization) %>% knitr::kable() 

#boxplot of difference in thickness (y axis) by randomization group (x axis)
ggplot(RCT_CT, aes(x= RandomArm, y = LThickness_change)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     ggtitle("Cortical thickness (left hemisphere)") +
     xlab(NULL) +
     ylab("Change in Cortical Thickness (mm)") +
     theme_minimal()
```

```{r RCT_LCT_stats}
#run linear model without covariates
  fit_rct <- lm(LThickness_change ~ RandomArm, data= RCT_CT)
  print(fit_rct)
  summary(fit_rct)

#run linear model with covariates of sex and age
  fit_rct <- lm(LThickness_change ~ RandomArm + sex + age, data= RCT_CT)
  print(fit_rct)
  summary(fit_rct)

  
#run linear model with covariates of sex and age
  fit_rct <- lm(LThickness_change ~ RandomArm + sex + age + site, data= RCT_CT)
  print(fit_rct)
  summary(fit_rct)
```

### looking at the same thing for Right CT

```{r RCT_RCT_boxplot}
#boxplot of difference in thickness (y axis) by randomization group (x axis)
ggplot(RCT_CT, aes(x= RandomArm, y = RThickness_change)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     ggtitle("Cortical thickness (right hemisphere)") +
     xlab(NULL) +
     ylab("Change in Cortical Thickness (mm)") +
     theme_minimal()
```
```{r RCT_CT_facet_boxplot}
#boxplot of difference in thickness (y axis) by randomization group (x axis)
RCT_CT %>%
  gather(TCT, mm, LThickness_change, RThickness_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LThickness_change", "RThickness_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere"))) %>%
ggplot(aes(x= RandomArm, y = mm)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs(title = "Change in Cortical Thickness",x = NULL, y = "Change in Cortical Thickness (mm)") +
     facet_wrap(~ ThickChange) +
     theme_bw()
```
```{r RCT_RCT_stats}
#run linear model without covariates
  fit_rct <- lm(RThickness_change ~ RandomArm, data= RCT_CT)
  print(fit_rct)
  summary(fit_rct)

#run linear model with covariates of sex and age
  fit_rct <- lm(RThickness_change ~ RandomArm + sex + age, data= RCT_CT)
  print(fit_rct)
  summary(fit_rct)

  
#run linear model with covariates of sex and age
  fit_rct <- lm(RThickness_change ~ RandomArm + sex + age + site, data= RCT_CT)
  print(fit_rct)
  summary(fit_rct)
```

## RCT & Relapse (with time as factor)

```{r the-ns}
#restructure data for RCT & Relapse participants (N=72)
  RCTRelapse_LCT <- df %>%
    gather(thick_oldcolname, thickness, LThickness_01, LThickness_02) %>%
    mutate(model_days = if_else(thick_oldcolname == "LThickness_01", 1, dateDiff))

RCTRelapse_LCT %>% filter(model_days == 1) %>% count(randomization) %>% knitr::kable() 

```

```{r RCTRelapse_LCT_plot, warning = FALSE}

#plot all data, including outlier (participant 210030)
  RCTRelapse_LCT %>%
   ggplot(aes(x=model_days, y=thickness, colour=RandomArm)) + 
   geom_point() + 
   geom_line(aes(group=STUDYID), alpha = 0.5) + 
   geom_smooth(method="lm", formula=y~poly(x,1)) +
   ggtitle("Cortical thickness in left hemisphere over time") +
   labs(x = "Days between MRIs", y = "Cortical Thickness (mm)", colour = NULL) +
   theme_minimal()
```

```{r RCTRelapse_LCT_stats, warning = FALSE}  
#run mixed linear model, with covariates
  fit_all <- lmer(thickness ~ RandomArm*model_days + sex + age + (1|STUDYID), data= RCTRelapse_LCT)
  summary(fit_all)

```

```{r RCTRelapse_CT_statswsite, warning = FALSE}  
#run mixed linear model, with covariates
  fit_all <- lmer(thickness ~ RandomArm*model_days + sex + age + site + (1|STUDYID), data= RCTRelapse_LCT)
  summary(fit_all)

```

### Running the right hemisphere RCTRelapse

```{r RCTRelapse_RCT_plot, warning = FALSE}

#restructure data for RCT & Relapse participants (N=72)
  RCTRelapse_RCT <- df %>%
    gather(thick_oldcolname, thickness, RThickness_01, RThickness_02) %>%
    mutate(model_days = if_else(thick_oldcolname == "RThickness_01", 1, dateDiff))

#plot all data, including outlier (participant 210030)
  RCTRelapse_RCT %>%
   ggplot(aes(x=model_days, y=thickness, colour=RandomArm)) + 
   geom_point() + 
   geom_line(aes(group=STUDYID), alpha = 0.5) + 
   geom_smooth(method="lm", formula=y~poly(x,1)) +
   ggtitle("Cortical thickness in right hemisphere over time") +
   labs(x = "Days between MRIs", y = "Cortical Thickness (mm)", colour = NULL) +
   theme_minimal()
```

```{r RCTRelapse_RCT_stats, warning = FALSE}  
#run mixed linear model, with covariates
  fit_all <- lmer(thickness ~ RandomArm*model_days + sex + age + (1|STUDYID), data= RCTRelapse_RCT)
  summary(fit_all)

```
```{r RCTRelapse_CT_statswsite, warning = FALSE}  
#run mixed linear model, with covariates
  fit_all <- lmer(thickness ~ RandomArm*model_days + sex + age + site + (1|STUDYID), data= RCTRelapse_RCT)
  summary(fit_all)

```