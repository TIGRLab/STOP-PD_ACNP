# Surface Area Analysis

This script analyses hemisphere wide surface area 

```{r set_up, message=FALSE, warning=FALSE}

#load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(growthmodels)


#bring in data 
df <- read_csv('../generated_csvs/STOPPD_participantsCT_20181111.csv') #generated by 05_STOPPD_error in prepartion of Jason Lerch meeting


```


```{r}
#make sure that STUDYID is an interger not a number
  df$STUDYID <- as.character(df$STUDYID)

#make sure that dateDiff is a number, not an interger
  df$dateDiff <- as.numeric(df$dateDiff)

# label the randomization variable  
df$RandomArm <- factor(df$randomization, 
                       levels = c("O", "P"),
                       labels = c("Olanzapine", "Placebo"))

#restructure data for RCT completers' only (N=40)
  RCT_SA <- df %>%
    filter(category == "RCT") 

#write out clean dataframe
 # write.csv(RCT_CT, '../generated_data/df_leftCT.csv', row.names=FALSE)

```


## RCT only



```{r RCT_LSA_boxplot}
RCT_SA %>% count(randomization) %>% knitr::kable() 

#boxplot of difference in thickness (y axis) by randomization group (x axis)
ggplot(RCT_SA, aes(x= RandomArm, y = LSurfArea_change)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     ggtitle("Surface Area (left hemisphere)") +
     xlab(NULL) +
     ylab("Change in Surface Area") +
     theme_minimal()
```

```{r RCT_LSA_stats}
#run linear model without covariates
  fit_rct <- lm(LSurfArea_change ~ RandomArm, data= RCT_SA)
  print(fit_rct)
  summary(fit_rct)

#run linear model with covariates of sex and age
  fit_rct <- lm(LSurfArea_change ~ RandomArm + sex + age, data= RCT_SA)
  print(fit_rct)
  summary(fit_rct)

  
#run linear model with covariates of sex and age
  fit_rct <- lm(LSurfArea_change ~ RandomArm + sex + age + site, data= RCT_SA)
  print(fit_rct)
  summary(fit_rct)
```

### looking at the same thing for Right SA

```{r RCT_RSA_boxplot}
#boxplot of difference in thickness (y axis) by randomization group (x axis)
ggplot(RCT_SA, aes(x= RandomArm, y = RSurfArea_change)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     ggtitle("Cortical thickness (right hemisphere)") +
     xlab(NULL) +
     ylab("Change in Cortical Thickness (mm)") +
     theme_minimal()
```
```{r RCT_SA_facet_boxplot}
#boxplot of difference in thickness (y axis) by randomization group (x axis)
RCT_SA %>%
  gather(TCT, mm, LSurfArea_change, RSurfArea_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LSurfArea_change", "RSurfArea_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere"))) %>%
ggplot(aes(x= RandomArm, y = mm)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_dotplot(binaxis = 'y', stackdir = 'center') +
     geom_hline(yintercept = 0) +
     labs(title = "Change in Surface Area",x = NULL, y = "Change in Cortical Surface Area") +
     facet_wrap(~ ThickChange) +
     theme_bw()
```
```{r RCT_RSA_stats}
#run linear model without covariates
  fit_rct <- lm(RSurfArea_change ~ RandomArm, data= RCT_SA)
  print(fit_rct)
  summary(fit_rct)

#run linear model with covariates of sex and age
  fit_rct <- lm(RSurfArea_change ~ RandomArm + sex + age, data= RCT_SA)
  print(fit_rct)
  summary(fit_rct)

  
#run linear model with covariates of sex and age
  fit_rct <- lm(RSurfArea_change ~ RandomArm + sex + age + site, data= RCT_SA)
  print(fit_rct)
  summary(fit_rct)
```

## RCT & Relapse (with time as factor)

```{r the-ns-LSA}
#restructure data for RCT & Relapse participants (N=72)
  RCTRelapse_LSA <- df %>%
    gather(oldcolname, SurfArea, LSurfArea_01, LSurfArea_02) %>%
    mutate(model_days = if_else(oldcolname == "LSurfArea_01", 1, dateDiff))

RCTRelapse_LSA %>% filter(model_days == 1) %>% count(randomization) %>% knitr::kable() 

```

```{r RCTRelapse_LSA_plot, warning = FALSE}

#plot all data, including outlier (participant 210030)
  RCTRelapse_LSA %>%
   ggplot(aes(x=model_days, y=SurfArea, colour=RandomArm)) + 
   geom_point() + 
   geom_line(aes(group=STUDYID), alpha = 0.5) + 
   geom_smooth(method="lm", formula=y~poly(x,1)) +
   ggtitle("Surface Area in left hemisphere over time") +
   labs(x = "Days between MRIs", y = "Surface Area", colour = NULL) +
   theme_minimal()
```

```{r RCTRelapse_LSA_stats, warning = FALSE}  
#run mixed linear model, with covariates
  fit_all <- lmer(SurfArea ~ RandomArm*model_days + sex + age + (1|STUDYID), data= RCTRelapse_LSA)
  summary(fit_all)

```

```{r RCTRelapse_LSA_statswsite, warning = FALSE}  
#run mixed linear model, with covariates
  fit_all <- lmer(SurfArea ~ RandomArm*model_days + sex + age + site + (1|STUDYID), data= RCTRelapse_LSA)
  summary(fit_all)

```

### Running the right hemisphere RCTRelapse

```{r RCTRelapse_RSA_plot, warning = FALSE}

#restructure data for RCT & Relapse participants (N=72)
  RCTRelapse_RSA <- df %>%
    gather(oldcolname, SurfArea, RSurfArea_01, RSurfArea_02) %>%
    mutate(model_days = if_else(oldcolname == "RSurfArea_01", 1, dateDiff))

#plot all data, including outlier (participant 210030)
  RCTRelapse_RSA %>%
   ggplot(aes(x=model_days, y=SurfArea, colour=RandomArm)) + 
   geom_point() + 
   geom_line(aes(group=STUDYID), alpha = 0.5) + 
   geom_smooth(method="lm", formula=y~poly(x,1)) +
   ggtitle("Surface Area in right hemisphere over time") +
   labs(x = "Days between MRIs", y = "Surface Area", colour = NULL) +
   theme_minimal()
```

```{r RCTRelapse_RSA_stats, warning = FALSE}  
#run mixed linear model, with covariates
  fit_all <- lmer(SurfArea ~ RandomArm*model_days + sex + age + (1|STUDYID), data= RCTRelapse_RSA)
  summary(fit_all)

```
```{r RCTRelapse_RSA_statswsite, warning = FALSE}  
#run mixed linear model, with covariates
  fit_all <- lmer(SurfArea ~ RandomArm*model_days + sex + age + site + (1|STUDYID), data= RCTRelapse_RSA)
  summary(fit_all)

```

## Dealing with the confusion..

So I (maybe for one) Was Confused by the way that the two findings above seems to go in opposite directions.

I.e. More the RCT analysis shows a decrease in surface area with Olanzapine, while the longitudinal fit is trending upward.

I thought it might be useful to rebuild the first plot, but with the whole sample, with point color representing the time between scans 

Note that the dark blue dots would be the one's included in the RCT analysis

```{r RCTRelapse_SA_facet_boxplot}
#boxplot of difference in thickness (y axis) by randomization group (x axis)
df %>%
  gather(TCT, mm, LSurfArea_change, RSurfArea_change) %>%
  mutate(ThickChange = factor(TCT, levels = c("LSurfArea_change", "RSurfArea_change"),
                              labels = c("Left Hemisphere", "Right Hemisphere"))) %>%
ggplot(aes(x= RandomArm, y = mm)) + 
     geom_boxplot(outlier.shape = NA) + 
     geom_jitter(aes(color = dateDiff)) +
     geom_hline(yintercept = 0) +
     labs(title = "Change in Surface Area",x = NULL, y = "Change in Cortical Surface Area") +
     facet_wrap(~ ThickChange) +
     scale_color_viridis_c(direction = -1) +
     theme_bw()
```

