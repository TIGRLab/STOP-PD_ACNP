---
title: |
  | <br><br><br><br>STOPPD mean diffusivity analysis
  | (left entorhinal cortex)
written: 2018-03-08
edited: 2018-09-09
lastrun: Sys.Date()
output: 
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: '2'
---

#This script analyses mean diffusivity in the left entorhinal cortex. 

```{r set_up, message=FALSE, warning=FALSE}

#load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(growthmodels)
```

```{r message=FALSE, warning=FALSE}
#bring in subject info (generated by 03_STOPPD_masterDF.Rmd)
# then take only the subjects who completed (n= 74)
df <- read_csv('../generated_csvs/STOPPD_masterDF_2018-11-05.csv') %>%
  mutate(STUDYID = as.character(STUDYID)) %>%
  filter(second_complete == "Yes") 

#rename timepoint variable for clarity
colnames(df)[colnames(df)=="second_timepoint"] <- "category" 

#make a datediff column for time between scans
df$dateDiff <- as.numeric(round(difftime(df$second_date, df$first_date, units = "days"), 0))

```
## Known exclusion reasons

#### known DWI issues

**subject 410012 timepoint 02** -> scan was blacklisted "aborted" for system failure..no DWI for this participant

**subject 220009_timepoint 01** -> scan was also incomplete (this participant was only able complete the T1w)

So we will filter the data table to exclude these 4 participants (final n=70)

```{r}
df <- filter(df, !(STUDYID %in% c("210030", "320032", "410012", "220009")))
```

## mangling the Mean Diffusivity cata data

Erin reran the enigma DTI pipeline for only PMC using a different skull stripping parameter (-fa 0.7 to BET). We will use these numbers instead of the others in the archive here..

```{r MD_datacleaning_general, message=FALSE, warning=FALSE}
#bring in MD data (from the filesystem)
MD_most <- read_csv('../data/enigma-DTI_archive_201809/enigmaDTI-MD-results.csv')
MD_PMC <- read_csv('../data/enigma-DTI_PMCredo_201809/enigmaDTI-MD-results.csv')

# separate id into it's parts and then drop old PMC data
MD_most <- MD_most %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  filter(site != "PMC")

# separate the PMC subject id into it's parts and then bind to the data from the other sites 
MD <- MD_PMC %>%
  separate(id, into = c("study", "site", "STUDYID", "timepoint")) %>%
  bind_rows(MD_most)

# drop acute ("00") and other ("03") timepoints from the analysis
MD <- MD %>% 
  filter(!(timepoint %in% c("00", "03"))) %>%
  gather(tract, MD, ends_with("MD")) %>%
  unite(tract_timepoint, tract, timepoint) %>%
  spread(tract_timepoint, MD)
```


## check for missing MD data

```{r}
# filter the master spreadsheet for the list of completers (no output means we are ok)
df %>%
  anti_join(MD, by = "STUDYID") %>%
  summarise(`Number of missing MD values` = n()) %>%
  knitr::kable()
```

## merge (i.e. join) the MD data with the clinical scores 

```{r}
all_MD <- df %>%
  select(STUDYID, sex, age, randomization, category, dateDiff) %>%
  left_join(MD, by = "STUDYID")

all_MD %>%
  filter(is.na(AverageFA_MD_01)) %>%
  summarise(`Number of missing timepoint 1 MD values` = n()) %>%
  knitr::kable()
```
```{r}
all_MD %>%
  filter(is.na(AverageFA_MD_02)) %>%
  summarise(`Number of missing timepoint 2 MD values` = n()) %>%
  knitr::kable()
```

```{r}
#write out clean MD speadsheet (required for subsequent MD analyses)
write.csv(all_MD, '../generated_csvs/STOPPD_MDclean.csv', row.names = FALSE)
```



```{r datacleaning, include = FALSE}

#turn off scientific notation
options(scipen = 999)

#make difference score
all_MD$diffAverageSkel_MD <- all_MD$AverageFA_MD_02 - all_MD$AverageFA_MD_01

#restructure data for RCT & Relapse participants (N=74)
RCTRelapse_MD <- all_MD %>%
  gather(oldcolname, MD, ends_with("MD_01"), ends_with("MD_02")) %>%
  separate(oldcolname, into = c("Tract", "metric_name", "timepoint"), sep = "_", fill = "left") %>%
  mutate(model_days = if_else(timepoint=="01", 1, dateDiff)) 

# filter data to only include the RCT completers in the first ana
RCT_MD <- all_MD %>%
  filter(category == "RCT")

#write out clean dataframe
#write.csv(RCT_FA, '../generated_data/df_MD_FA.csv', row.names=FALSE)

```

## RCT only

```{r RCT_MD_meanSkel_plot, warning = FALSE}
#boxplot of difference in MD in whole skeleton (y axis) by randomization group (x axis)
ggplot(RCT_MD, aes(x= randomization, y = diffAverageSkel_MD)) + 
   geom_boxplot(outlier.shape = NA) + 
   geom_dotplot(binaxis = 'y', stackdir = 'center') +
   ggtitle("Whole skeleton mean diffusivity") +
   xlab("randomization condition") +  
   ylab("difference between timepoints")

#Note: the outlying participant is again 210030; this participant has NOT been excluded from subsequent stats
```


```{r RCT_MD_meanSkel_stats, warning = FALSE}
fit_rct <- lm(diffAverageSkel_MD ~ randomization, data= RCT_MD)
print(fit_rct)
summary(fit_rct)

#run linear model with covariates of sex and age
fit_rct <- lm(diffAverageSkel_MD ~ randomization + sex + age, data= RCT_MD)
print(fit_rct)
summary(fit_rct)

#run linear model with covariates of sex, age and site
fit_rct <- lm(diffAverageSkel_MD ~ randomization + sex + age + site, data= RCT_MD)
print(fit_rct)
summary(fit_rct)
```

## RCT & Relapse (with time as factor)


```{r RCTRelapse_MD_plot, warning = FALSE}
RCTRelapse_wholeskelMD <- RCTRelapse_MD %>%
  filter(Tract == "AverageFA")
#plot
RCTRelapse_wholeskelMD %>%
  ggplot(aes(x=model_days, y=MD, colour=randomization)) + 
  geom_point() + 
  geom_line(aes(group=STUDYID), alpha = 0.5) + 
  geom_smooth(method="lm", formula=y~poly(x,1)) +
  ggtitle("Whole skeleton mean diffusivity over time") +    
  xlab("days between MRIs") +  
  ylab("Mean Diffusivity") +
  theme_minimal()
```

```{r RCTRelapse_MD_stats, warning = FALSE}
#run mixed linear model, with covariates
fit_all <- lmer(MD ~ randomization*model_days + sex + age + (1|STUDYID), data= RCTRelapse_wholeskelMD)
summary(fit_all)

#cleanup
rm('df', 'fit_all', 'fit_rct', 'MD', 'plot', 'RCT_FA', 'RCTRelapse_FA')

```
## just wanna through in one site model..

```{r RCTRelapse_MD_statswsite, warning = FALSE}
#run mixed linear model, with covariates
fit_all <- lmer(MD ~ randomization*model_days + sex + age + site + (1|STUDYID), data= RCTRelapse_wholeskelMD)
summary(fit_all)
```